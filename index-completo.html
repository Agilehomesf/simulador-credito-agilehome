<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Crédito Hipotecario Multibanco Agile Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }
    .header-title {
      color: #2c3e50;
      font-weight: bold;
    }
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: rgba(0, 123, 255, 0.1);
      font-weight: bold;
    }
    .bank-card {
      transition: all 0.3s ease;
    }
    .bank-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    .monthly-payment {
      font-size: 1.5rem;
      font-weight: bold;
      color: #007bff;
    }
    .rate-value {
      font-weight: bold;
      color: #28a745;
    }
    .amortization-table {
      font-size: 0.9rem;
    }
    .amortization-container {
      max-height: 300px;
      overflow-y: auto;
    }
    .btn-whatsapp {
      background-color: #25D366;
      border-color: #25D366;
    }
    .btn-whatsapp:hover {
      background-color: #1eb959;
      border-color: #1eb959;
    }
    .heat-map-cell {
      padding: 8px;
      border-radius: 4px;
      color: #333;
    }
    .footer {
      background-color: #f8f9fa;
      padding: 30px 0;
      border-top: 1px solid #e7e7e7;
      margin-top: 50px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="bg-white py-3 shadow-sm">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-12 text-center">
          <h1 class="header-title">Simulador de Crédito Hipotecario Multibanco Agile Home</h1>
          <p class="text-muted">Compare opciones de préstamos hipotecarios en Colombia</p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="py-4">
    <div class="container">
      <!-- Introduction Card -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="text-primary mb-3">¿Cómo funciona?</h5>
          <p>Este simulador le permite calcular y comparar cuotas mensuales de créditos hipotecarios ofrecidos por diferentes bancos en Colombia. Ingrese los datos solicitados para obtener una estimación de sus pagos mensuales.</p>
          <div class="row mt-3 text-center">
            <div class="col-md-4 mb-3 mb-md-0">
              <i class="bi bi-house-door fs-1 text-primary"></i>
              <h6 class="mt-2">Ingrese el valor de la vivienda</h6>
            </div>
            <div class="col-md-4 mb-3 mb-md-0">
              <i class="bi bi-calculator fs-1 text-primary"></i>
              <h6 class="mt-2">Defina la cuota inicial y el plazo</h6>
            </div>
            <div class="col-md-4">
              <i class="bi bi-bank fs-1 text-primary"></i>
              <h6 class="mt-2">Compare entre diferentes bancos</h6>
            </div>
          </div>
        </div>
      </div>

      <!-- Loan Calculator Form -->
      <div class="card mb-4">
        <div class="card-header">
          Información del Préstamo
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Property Value -->
            <div class="col-md-6 mb-3">
              <label for="propertyValue" class="form-label">Valor de la vivienda <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Ingrese el valor total de la propiedad que desea adquirir"></i></label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="propertyValue" placeholder="Ej. 200.000.000" required>
              </div>
            </div>

            <!-- Down Payment -->
            <div class="col-md-6 mb-3">
              <label for="downPayment" class="form-label">Cuota inicial <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Se recomienda una cuota inicial de al menos 20% del valor de la vivienda"></i></label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="downPayment" placeholder="Ej. 40.000.000" required>
              </div>
              <div class="d-flex justify-content-between">
                <small class="text-muted">Equivale al <span id="downPaymentPercentage">0</span>% del valor</small>
                <small id="downPaymentFeedback" class="text-danger d-none">Se recomienda un mínimo de 20% de cuota inicial</small>
              </div>
            </div>

            <!-- Loan Amount Summary -->
            <div class="col-12 mb-3">
              <div class="alert alert-info">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>Monto a financiar:</strong>
                  </div>
                  <div>
                    <strong>$<span id="loanAmount">0</span></strong>
                  </div>
                </div>
              </div>
            </div>

            <!-- Loan Term -->
            <div class="col-md-6 mb-3">
              <label for="loanTerm" class="form-label">Plazo en años <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="Período de tiempo para pagar el préstamo, entre 5 y 30 años"></i></label>
              <select class="form-select" id="loanTerm" required>
                <option value="" selected disabled>Seleccione el plazo</option>
                <option value="5">5 años</option>
                <option value="10">10 años</option>
                <option value="15">15 años</option>
                <option value="20">20 años</option>
                <option value="25">25 años</option>
                <option value="30">30 años</option>
              </select>
            </div>
          </div>

          <!-- Form Buttons -->
          <div class="d-flex justify-content-between mt-3">
            <button type="button" id="resetBtn" class="btn btn-outline-secondary">
              Reiniciar
            </button>
            <button type="button" id="calculateBtn" class="btn btn-primary">
              Calcular cuotas
            </button>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultsContainer" class="d-none">
        <h3 class="text-primary mb-4">
          Resultados de la Simulación
        </h3>
        
        <!-- Results Content -->
        <div id="resultsContent"></div>
        
        <!-- WhatsApp Contact Button -->
        <div class="text-center my-4">
          <br>
          <a href="https://wa.me/message/PMWO6BQHZCRSD1" target="_blank" class="btn btn-whatsapp btn-lg">
            <i class="bi bi-whatsapp me-2"></i>Contactar asesor por WhatsApp
          </a>
          <p class="text-muted mt-2"><small>Un asesor de Agile Home te brindará información detallada sobre tu simulación</small></p>
        </div>
        
        <!-- Comparison Chart -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-bar-chart-fill me-2"></i>Comparativa de Cuotas Mensuales
          </div>
          <div class="card-body">
            <div style="max-height: 250px;">
              <canvas id="comparisonChart" height="200"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Interest Rate Heat Map -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-grid-3x3-gap me-2"></i>Mapa de Calor de Tasas de Interés
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">Este mapa de calor muestra visualmente qué bancos ofrecen las mejores tasas de interés. Los colores más verdes indican tasas más bajas, mientras que los colores más rojos indican tasas más altas.</p>
            <div id="heatMapContainer">
              <div class="table-responsive">
                <table id="interestRateHeatMap" class="table table-bordered">
                  <thead class="table-primary">
                    <tr>
                      <th>Banco</th>
                      <th>Tasa EA</th>
                      <th>Tasa MV</th>
                      <th>Comparativa Visual</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Se llenará dinámicamente con JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Disclaimer -->
        <div id="legales" class="mt-4 p-3 bg-light rounded">
          <strong>Esta herramienta realiza estimaciones aproximadas en Pesos Colombianos (COP).</strong>
          <ul class="mb-0 mt-2">
            <li>Las tasas de interés y condiciones pueden variar según la política de cada entidad financiera.</li>
            <li>La cuota mensual no incluye seguros ni otros costos asociados.</li>
            <li>La tasa definitiva aplicará según las condiciones vigentes al momento del desembolso.</li>
            <li>Para conocer el detalle de cada banco, contacta a tu asesor de Agile Home.</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <h5>Simulador de Crédito Hipotecario Multibanco Agile Home</h5>
          <div class="mb-0">
            <strong>Esta herramienta realiza estimaciones aproximadas en Pesos Colombianos (COP).</strong>
            <ul class="mb-0 mt-1">
              <li>Las tasas de interés y condiciones pueden variar según la política de cada entidad financiera.</li>
              <li>La cuota mensual no incluye seguros ni otros costos asociados.</li>
              <li>La tasa definitiva aplicará según las condiciones vigentes al momento del desembolso.</li>
              <li>Para conocer el detalle de cada banco, contacta a tu asesor de Agile Home.</li>
            </ul>
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <p class="mb-0">© 2025 Simulador Multibanco Agile Home</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- JavaScript Principal -->
  <script>
    // Datos de los bancos
    const banks = {
      "Banco de Occidente": {
        rate: 0.1290,
        rateDescription: "Desde",
        logoClass: "bi-bank"
      },
      "Banco Caja Social": {
        rate: 0.1310,
        rateDescription: "Tasa promedio",
        logoClass: "bi-house"
      },
      "Credifamilia": {
        rate: 0.1410,
        rateDescription: "Desde",
        logoClass: "bi-building"
      },
      "BBVA": {
        rate: 0.1265,
        rateDescription: "Tasa promedio",
        logoClass: "bi-bank2"
      },
      "Itaú": {
        rate: 0.1380,
        rateDescription: "Desde",
        logoClass: "bi-building-fill"
      },
      "Banco de Bogotá": {
        rate: 0.1275,
        rateDescription: "Desde",
        logoClass: "bi-bank"
      }
    };

    // Inicialización cuando el documento está listo
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar tooltips de Bootstrap
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Referencias a elementos del DOM
      const propertyValueInput = document.getElementById('propertyValue');
      const downPaymentInput = document.getElementById('downPayment');
      const loanAmountDisplay = document.getElementById('loanAmount');
      const downPaymentPercentageDisplay = document.getElementById('downPaymentPercentage');
      const calculateBtn = document.getElementById('calculateBtn');
      const resetBtn = document.getElementById('resetBtn');

      // Event listeners
      propertyValueInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      downPaymentInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      calculateBtn.addEventListener('click', calculateMortgage);
      
      resetBtn.addEventListener('click', resetForm);
    });

    // Formatear número como moneda colombiana
    function formatCurrency(value) {
      const num = value.toString().replace(/\D/g, '');
      return new Intl.NumberFormat('es-CO', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(num);
    }

    // Formatear entrada de moneda mientras se escribe
    function formatInputCurrency(input) {
      const cursorPosition = input.selectionStart;
      const oldLength = input.value.length;
      const cleanValue = input.value.replace(/\D/g, '');
      
      if (cleanValue) {
        input.value = formatCurrency(cleanValue);
      } else {
        input.value = '';
      }
      
      // Ajustar posición del cursor
      const newLength = input.value.length;
      const newPosition = cursorPosition + (newLength - oldLength);
      if (newPosition >= 0) {
        input.setSelectionRange(newPosition, newPosition);
      }
    }

    // Convertir string de moneda a número
    function parseCurrency(value) {
      return parseInt(value.toString().replace(/\D/g, '')) || 0;
    }

    // Calcular y mostrar monto del préstamo
    function calculateLoanAmount() {
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
      const downPayment = parseCurrency(document.getElementById('downPayment').value);
      
      // Calcular monto del préstamo
      let loanAmount = propertyValue - downPayment;
      if (loanAmount < 0) loanAmount = 0;
      
      // Actualizar pantalla
      const loanAmountDisplay = document.getElementById('loanAmount');
      loanAmountDisplay.textContent = formatCurrency(loanAmount);
      
      // Calcular porcentaje de cuota inicial
      const downPaymentPercentage = propertyValue > 0 ? (downPayment / propertyValue * 100).toFixed(1) : 0;
      document.getElementById('downPaymentPercentage').textContent = downPaymentPercentage;
      
      // Validar cuota inicial (debería ser al menos 20% en Colombia)
      const downPaymentFeedback = document.getElementById('downPaymentFeedback');
      if (propertyValue > 0 && downPaymentPercentage < 20) {
        downPaymentFeedback.textContent = 'Se recomienda un mínimo de 20% de cuota inicial';
        downPaymentFeedback.classList.remove('d-none');
      } else {
        downPaymentFeedback.classList.add('d-none');
      }
    }

    // Función principal de cálculo
    function calculateMortgage() {
      // Obtener valores de entrada
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
      const downPayment = parseCurrency(document.getElementById('downPayment').value);
      const loanTerm = parseInt(document.getElementById('loanTerm').value);
      
      // Validar entradas
      if (propertyValue <= 0) {
        alert('Por favor, ingrese un valor de vivienda válido.');
        return;
      }
      
      if (downPayment <= 0) {
        alert('Por favor, ingrese una cuota inicial válida.');
        return;
      }
      
      if (downPayment >= propertyValue) {
        alert('La cuota inicial no puede ser mayor o igual al valor de la propiedad.');
        return;
      }
      
      if (isNaN(loanTerm) || loanTerm < 5 || loanTerm > 30) {
        alert('Por favor, seleccione un plazo válido entre 5 y 30 años.');
        return;
      }
      
      // Mostrar estado de carga
      const calculateBtn = document.getElementById('calculateBtn');
      const originalBtnText = calculateBtn.innerHTML;
      calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Calculando...';
      calculateBtn.disabled = true;
      
      // Calcular monto del préstamo
      const loanAmount = propertyValue - downPayment;
      
      // Procesar cálculos bancarios con un ligero retraso para mostrar el estado de carga
      setTimeout(() => {
        // Calcular para cada banco
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsContent = document.getElementById('resultsContent');
        
        // Limpiar resultados anteriores
        resultsContent.innerHTML = '';
        
        // Ordenar bancos por pago mensual (menor primero)
        const bankResults = [];
        
        // Restricción especial: Si el plazo es mayor a 20 años y el valor del inmueble no supera $213.525.000
        // solo mostramos el Banco de Bogotá
        const mostrarSoloBogota = loanTerm > 20 && propertyValue <= 213525000;
        
        for (const bankName in banks) {
          // Si aplica la restricción especial y no es Banco de Bogotá, saltamos este banco
          if (mostrarSoloBogota && bankName !== "Banco de Bogotá") {
            continue;
          }
          
          const bank = banks[bankName];
          const yearlyRate = bank.rate;
          const monthlyRate = yearlyRate / 12;
          const paymentPeriods = loanTerm * 12;
          
          // Calcular pago mensual usando la fórmula: P = L[c(1+c)^n]/[(1+c)^n-1]
          // Donde P = pago mensual, L = monto del préstamo, c = tasa de interés mensual, n = número de pagos
          const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, paymentPeriods)) / (Math.pow(1 + monthlyRate, paymentPeriods) - 1);
          
          // Calcular interés total
          const totalPayment = monthlyPayment * paymentPeriods;
          const totalInterest = totalPayment - loanAmount;
          
          bankResults.push({
            bankName: bankName,
            logoClass: bank.logoClass,
            yearlyRate: yearlyRate,
            monthlyRate: (Math.pow(1 + yearlyRate, 1/12) - 1),
            rateDescription: bank.rateDescription || "",
            monthlyPayment: monthlyPayment,
            totalPayment: totalPayment,
            totalInterest: totalInterest
          });
        }
        
        // Si no hay resultados (caso raro), mostramos un mensaje de advertencia
        if (bankResults.length === 0) {
          alert('No hay bancos disponibles para los criterios seleccionados. Por favor ajusta el plazo o valor del inmueble.');
          
          // Restaurar estado del botón
          calculateBtn.innerHTML = originalBtnText;
          calculateBtn.disabled = false;
          return;
        }
        
        // Ordenar por pago mensual
        bankResults.sort((a, b) => a.monthlyPayment - b.monthlyPayment);
        
        // Crear tarjetas de resultados
        bankResults.forEach((result, index) => {
          const isBestRate = index === 0 ? '<span class="badge bg-success ms-2">Mejor opción</span>' : '';
          
          const resultCard = document.createElement('div');
          resultCard.className = 'card bank-card mb-3';
          resultCard.innerHTML = `
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-lg-3 text-center text-lg-start mb-3 mb-lg-0">
                  <i class="bi ${result.logoClass} fs-1 text-primary"></i>
                  <h5 class="mb-0">${result.bankName}${isBestRate}</h5>
                </div>
                <div class="col-lg-3 text-center mb-3 mb-lg-0">
                  <div class="text-muted">Tasas</div>
                  <div class="rate-value">${result.rateDescription ? result.rateDescription + ' ' : ''}${(result.yearlyRate * 100).toFixed(2)}% EA</div>
                  <div class="text-muted">${(result.monthlyRate * 100).toFixed(2)}% MV</div>
                </div>
                <div class="col-lg-3 text-center mb-3 mb-lg-0">
                  <div class="text-muted">Cuota Mensual</div>
                  <div class="monthly-payment">$${formatCurrency(Math.round(result.monthlyPayment))}</div>
                </div>
                <div class="col-lg-3 text-center">
                  <button class="btn btn-outline-primary view-details-btn" data-bank="${result.bankName.replace(/\s+/g, '-')}">Ver detalles</button>
                </div>
              </div>
              <div class="mt-3 bank-details d-none" id="details-${result.bankName.replace(/\s+/g, '-')}">
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="mb-3">Detalles del Préstamo</h6>
                    <table class="table table-sm table-bordered">
                      <tr>
                        <th>Valor de la propiedad:</th>
                        <td>$${formatCurrency(propertyValue)}</td>
                      </tr>
                      <tr>
                        <th>Cuota inicial:</th>
                        <td>$${formatCurrency(downPayment)} (${(downPayment / propertyValue * 100).toFixed(1)}%)</td>
                      </tr>
                      <tr>
                        <th>Monto del crédito:</th>
                        <td>$${formatCurrency(loanAmount)}</td>
                      </tr>
                      <tr>
                        <th>Plazo:</th>
                        <td>${loanTerm} años (${loanTerm * 12} meses)</td>
                      </tr>
                      <tr>
                        <th>Tasa EA:</th>
                        <td>${result.rateDescription ? result.rateDescription + ' ' : ''}${(result.yearlyRate * 100).toFixed(2)}%</td>
                      </tr>
                      <tr>
                        <th>Tasa MV:</th>
                        <td>${(result.monthlyRate * 100).toFixed(2)}%</td>
                      </tr>
                      <tr>
                        <th>Cuota mensual:</th>
                        <td>$${formatCurrency(Math.round(result.monthlyPayment))}</td>
                      </tr>
                      <tr>
                        <th>Total a pagar:</th>
                        <td>$${formatCurrency(Math.round(result.totalPayment))}</td>
                      </tr>
                      <tr>
                        <th>Intereses totales:</th>
                        <td>$${formatCurrency(Math.round(result.totalInterest))}</td>
                      </tr>
                    </table>
                  </div>
                  <div class="col-md-6">
                    <h6 class="mb-3">Tabla de Amortización (por año)</h6>
                    <div class="amortization-container">
                      <table class="table table-sm table-striped table-bordered amortization-table">
                        <thead>
                          <tr>
                            <th>Año</th>
                            <th>Capital</th>
                            <th>Intereses</th>
                            <th>Saldo</th>
                          </tr>
                        </thead>
                        <tbody id="amortization-${result.bankName.replace(/\s+/g, '-')}">
                          ${generateAmortizationTableHTML(loanAmount, result.monthlyRate, result.monthlyPayment, loanTerm)}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          resultsContent.appendChild(resultCard);
          
          // Añadir event listener al botón "Ver detalles"
          const detailsBtn = resultCard.querySelector('.view-details-btn');
          detailsBtn.addEventListener('click', function() {
            const bankId = this.getAttribute('data-bank');
            const detailsSection = document.getElementById(`details-${bankId}`);
            
            if (detailsSection.classList.contains('d-none')) {
              // Cerrar todos los detalles primero
              document.querySelectorAll('.bank-details').forEach(el => {
                el.classList.add('d-none');
              });
              
              // Cambiar texto de todos los botones a "Ver detalles"
              document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.textContent = 'Ver detalles';
              });
              
              // Mostrar los detalles de este banco
              detailsSection.classList.remove('d-none');
              this.textContent = 'Ocultar detalles';
            } else {
              // Ocultar los detalles
              detailsSection.classList.add('d-none');
              this.textContent = 'Ver detalles';
            }
          });
        });
        
        // Mostrar contenedor de resultados
        resultsContainer.classList.remove('d-none');
        
        // Generar gráfico comparativo
        generateComparisonChart(bankResults);
        
        // Generar mapa de calor de tasas de interés
        generateInterestRateHeatMap(bankResults);
        
        // Restaurar estado del botón
        calculateBtn.innerHTML = originalBtnText;
        calculateBtn.disabled = false;
        
        // Desplazarse a los resultados
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
      }, 500);
    }

    // Generar tabla de amortización
    function generateAmortizationTableHTML(loanAmount, monthlyRate, monthlyPayment, loanTermYears) {
      let html = '';
      let remainingBalance = loanAmount;
      const periods = loanTermYears * 12;
      
      let yearlyPrincipal = 0;
      let yearlyInterest = 0;
      
      // Para cada período de pago (mes)
      for (let i = 1; i <= periods; i++) {
        // Calcular interés para este período
        const interestForPeriod = remainingBalance * monthlyRate;
        
        // Calcular principal para este período
        const principalForPeriod = monthlyPayment - interestForPeriod;
        
        // Actualizar yearlyPrincipal y yearlyInterest
        yearlyPrincipal += principalForPeriod;
        yearlyInterest += interestForPeriod;
        
        // Actualizar saldo restante
        remainingBalance -= principalForPeriod;
        
        // Si este es el último mes de un año (o el último pago), añadir a yearlyData
        if (i % 12 === 0 || i === periods) {
          const year = Math.ceil(i / 12);
          html += `
            <tr>
              <td>${year}</td>
              <td>$${formatCurrency(Math.round(yearlyPrincipal))}</td>
              <td>$${formatCurrency(Math.round(yearlyInterest))}</td>
              <td>$${formatCurrency(Math.max(0, Math.round(remainingBalance)))}</td>
            </tr>
          `;
          
          // Reiniciar contadores anuales
          yearlyPrincipal = 0;
          yearlyInterest = 0;
        }
      }
      
      return html;
    }

    // Generar gráfico comparativo
    function generateComparisonChart(bankResults) {
      const ctx = document.getElementById('comparisonChart').getContext('2d');
      
      // Destruir gráfico existente si existe
      if (window.comparisonChart) {
        window.comparisonChart.destroy();
      }
      
      // Preparar datos
      const labels = bankResults.map(result => result.bankName);
      const monthlyPayments = bankResults.map(result => Math.round(result.monthlyPayment));
      
      // Crear gráfico
      window.comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Cuota Mensual',
              data: monthlyPayments,
              backgroundColor: 'rgba(54, 162, 235, 0.7)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Cuota Mensual: $${formatCurrency(context.raw)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return `$${formatCurrency(value)}`;
                }
              }
            }
          }
        }
      });
    }

    // Generar mapa de calor de tasas de interés
    function generateInterestRateHeatMap(bankResults) {
      const heatMapTable = document.getElementById('interestRateHeatMap').querySelector('tbody');
      
      // Limpiar contenido previo
      heatMapTable.innerHTML = '';
      
      // Ordenar bancos por tasa anual (menor primero)
      const sortedResults = [...bankResults].sort((a, b) => a.yearlyRate - b.yearlyRate);
      
      // Obtener la tasa más baja como base para comparación
      const lowestRate = sortedResults[0].yearlyRate;
      
      // Generar filas para cada banco
      sortedResults.forEach(result => {
        const row = document.createElement('tr');
        
        // Calcular diferencia porcentual respecto a la tasa más baja
        const percentageDiff = result.yearlyRate === lowestRate 
          ? 0 
          : ((result.yearlyRate - lowestRate) / lowestRate) * 100;
        
        // Generar color basado en la diferencia porcentual
        let bgColor;
        if (percentageDiff === 0) {
          bgColor = 'rgba(40, 167, 69, 0.8)'; // Mejor tasa (verde)
        } else if (percentageDiff <= 5) {
          bgColor = 'rgba(40, 167, 69, 0.5)'; // Hasta 5% más alta (verde claro)
        } else if (percentageDiff <= 10) {
          bgColor = 'rgba(255, 193, 7, 0.5)'; // 5-10% más alta (amarillo)
        } else if (percentageDiff <= 15) {
          bgColor = 'rgba(255, 145, 0, 0.5)'; // 10-15% más alta (naranja)
        } else {
          bgColor = 'rgba(220, 53, 69, 0.5)'; // >15% más alta (rojo)
        }
        
        // Generar texto para la celda de comparación
        let comparisonText = '';
        if (percentageDiff === 0) {
          comparisonText = 'Mejor tasa de interés';
        } else {
          comparisonText = `+${percentageDiff.toFixed(1)}% respecto a la mejor tasa`;
        }
        
        // Generar HTML de la fila
        row.innerHTML = `
          <td>${result.bankName}</td>
          <td>${result.rateDescription ? result.rateDescription + ' ' : ''}${(result.yearlyRate * 100).toFixed(2)}%</td>
          <td>${(result.monthlyRate * 100).toFixed(2)}%</td>
          <td class="text-center">
            <div class="heat-map-cell" style="background-color: ${bgColor};">
              ${comparisonText}
            </div>
          </td>
        `;
        
        heatMapTable.appendChild(row);
      });
    }

    // Resetear formulario
    function resetForm() {
      document.getElementById('propertyValue').value = '';
      document.getElementById('downPayment').value = '';
      document.getElementById('loanTerm').value = '';
      document.getElementById('loanAmount').textContent = '0';
      document.getElementById('downPaymentPercentage').textContent = '0';
      document.getElementById('downPaymentFeedback').classList.add('d-none');
      
      // Ocultar resultados
      document.getElementById('resultsContainer').classList.add('d-none');
    }
  </script>
</body>
</html>
