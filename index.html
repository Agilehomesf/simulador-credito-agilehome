<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Crédito Hipotecario Multibanco Agile Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #020e2e;       /* Azul Oscuro (color principal) */
      
      --secondary-color: #b0b0b0;     /* Gris Claro */
      --success-color: #fd4c0b;       /* Naranja (éxito) */
      --info-color:  #b0b0b0;          /* Gris Claro (información) */
      --warning-color: #f39c12;       /* Naranja (advertencia) */
      --danger-color: #e74c3c;        /* Rojo (error) */
      --light-color: #ecf0f1;         /* Gris claro (fondos) */
      --dark-color:  #020e2e;          /* Azul oscuro (texto) */
    }
    
    body { 
      font-family: 'Segoe UI', sans-serif;
      color: var(--dark-color);
    }
    
    .card { 
      border-radius: 8px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
      margin-bottom: 20px; 
      border-color: #e1e1e1;
    }
    
    .card-header {
      background-color: rgba(52, 152, 219, 0.1);
      font-weight: bold;
      color: var(--primary-color);
    }
    
    /* Cabecera */
    header { 
      background-color: white;
      border-bottom: 1px solid #e1e1e1;
    }
    
    .header-title { 
      color: var(--primary-color);
      font-weight: bold;
    }
    
    /* Botones */
    .btn-primary { 
      background-color: var(--primary-color); 
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover { 
      background-color: var(--primary-hover); 
      border-color: var(--primary-hover);
    }
    
    .btn-success {
      background-color: var(--success-color);
      border-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #219d54;
      border-color: #219d54;
    }
    
    /* Cuota mensual destacada */
    .monthly-payment { 
      font-size: 1.3rem; 
      font-weight: bold; 
      color: var(--primary-color);
    }
    
    /* Mapa de calor */
    .heat-map-cell { 
      padding: 6px; 
      border-radius: 4px;
    }
    
    /* Alertas */
    .alert-info {
      background-color: rgba(52, 152, 219, 0.1);
      border-color: rgba(52, 152, 219, 0.2);
      color: var(--primary-color);
    }
    
    /* Footer */
    .footer {
      background-color: #f8f9fa;
      border-top: 1px solid #e1e1e1;
      padding: 30px 0;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <header class="py-3 shadow-sm">
    <div class="container">
      <h1 class="text-center header-title">Simulador de Crédito Hipotecario Multibanco Agile Home</h1>
      <p class="text-center text-muted">Compare opciones de préstamos hipotecarios en Colombia</p>
    </div>
  </header>

  <main class="py-4">
    <div class="container">
      <div class="card mb-4">
        <div class="card-header">Información del Préstamo</div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="propertyValue" class="form-label">Valor de la vivienda</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="propertyValue" placeholder="Ej. 200.000.000">
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="downPayment" class="form-label">Cuota inicial</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="downPayment" placeholder="Ej. 40.000.000">
              </div>
              <div><small class="text-muted">Equivale al <span id="downPaymentPercentage">0</span>% del valor</small></div>
            </div>
            <div class="col-12 mb-3">
              <div class="alert alert-info">
                <strong>Monto a financiar: $<span id="loanAmount">0</span></strong>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="loanTerm" class="form-label">Plazo en años</label>
              <select class="form-select" id="loanTerm">
                <option value="" selected disabled>Seleccione el plazo</option>
                <option value="5">5 años</option>
                <option value="10">10 años</option>
                <option value="15">15 años</option>
                <option value="20">20 años</option>
                <option value="25">25 años</option>
                <option value="30">30 años</option>
              </select>
            </div>
          </div>
          <div class="d-flex justify-content-between mt-3">
            <button type="button" id="resetBtn" class="btn btn-outline-secondary">Reiniciar</button>
            <button type="button" id="calculateBtn" class="btn btn-primary">Calcular cuotas</button>
          </div>
        </div>
      </div>

      <div id="resultsContainer" class="d-none">
        <h3 class="mb-4 text-primary">Resultados de la Simulación</h3>
        <div id="resultsContent"></div>
        
        <!-- Gráfica Comparativa -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-bar-chart-fill me-2"></i>Comparativa de Cuotas Mensuales
          </div>
          <div class="card-body">
            <canvas id="comparisonChart" height="200"></canvas>
          </div>
        </div>
        
        <!-- Mapa de Calor de Tasas -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-grid-3x3-gap me-2"></i>Mapa de Calor de Tasas de Interés
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">Este mapa de calor muestra visualmente qué bancos ofrecen las mejores tasas de interés. Los colores más verdes indican tasas más bajas, mientras que los colores más rojos indican tasas más altas.</p>
            <div class="table-responsive">
              <table id="interestRateHeatMap" class="table table-bordered">
                <thead class="table-primary">
                  <tr>
                    <th>Banco</th>
                    <th>Tasa EA</th>
                    <th>Tasa MV</th>
                    <th>Comparativa Visual</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Se llenará dinámicamente con JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="text-center my-4">
          <a href="https://wa.me/message/PMWO6BQHZCRSD1" target="_blank" class="btn btn-success btn-lg">
            <i class="bi bi-whatsapp me-2"></i>Contactar asesor por WhatsApp
          </a>
          <p class="text-muted mt-2"><small>Un asesor de Agile Home te brindará información detallada sobre tu simulación</small></p>
        </div>
        
        <div id="legales" class="mt-4 p-3 bg-light rounded">
          <strong>Esta herramienta realiza estimaciones aproximadas en Pesos Colombianos (COP).</strong>
          <ul class="mb-0 mt-2">
            <li>Las tasas de interés y condiciones pueden variar según la política de cada entidad financiera.</li>
            <li>La cuota mensual no incluye seguros ni otros costos asociados.</li>
            <li>La tasa definitiva aplicará según las condiciones vigentes al momento del desembolso.</li>
            <li>Para conocer el detalle de cada banco, contacta a tu asesor de Agile Home.</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <h5 class="text-primary">Simulador de Crédito Hipotecario Multibanco Agile Home</h5>
          <div class="mb-0">
            <strong>Esta herramienta realiza estimaciones aproximadas en Pesos Colombianos (COP).</strong>
            <ul class="mb-0 mt-1">
              <li>Las tasas de interés y condiciones pueden variar según la política de cada entidad financiera.</li>
              <li>La cuota mensual no incluye seguros ni otros costos asociados.</li>
              <li>Para conocer el detalle de cada banco, contacta a tu asesor de Agile Home.</li>
            </ul>
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <p class="mb-0">© 2025 Simulador Multibanco Agile Home</p>
          <div id="lastUpdated" class="text-muted small"></div>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Datos de los bancos
    let banks = {
      "Banco de Occidente": { rate: 0.1290, rateDescription: "Desde", logoClass: "bi-bank" },
      "Banco Caja Social": { rate: 0.1310, rateDescription: "Tasa promedio", logoClass: "bi-house" },
      "Credifamilia": { rate: 0.1410, rateDescription: "Desde", logoClass: "bi-building" },
      "BBVA": { rate: 0.1265, rateDescription: "Tasa promedio", logoClass: "bi-bank2" },
      "Itaú": { rate: 0.1380, rateDescription: "Desde", logoClass: "bi-building-fill" },
      "Banco de Bogotá": { rate: 0.1275, rateDescription: "Desde", logoClass: "bi-bank" }
    };

    // Inicialización
    document.addEventListener('DOMContentLoaded', async function() {
      // Intentar cargar tasas desde archivo externo
      try {
        const response = await fetch('tasas_bancarias.json');
        if (response.ok) {
          const data = await response.json();
          banks = data.banks;
          
          // Mostrar fecha de actualización si existe
          if (data.lastUpdated) {
            document.getElementById('lastUpdated').textContent = `Tasas actualizadas: ${data.lastUpdated}`;
          }
        }
      } catch (error) {
        console.error('Error al cargar tasas desde archivo:', error);
        // Continuará usando los datos predeterminados definidos arriba
      }
      
      const propertyValueInput = document.getElementById('propertyValue');
      const downPaymentInput = document.getElementById('downPayment');
      const calculateBtn = document.getElementById('calculateBtn');
      const resetBtn = document.getElementById('resetBtn');

      propertyValueInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      downPaymentInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      calculateBtn.addEventListener('click', calculateMortgage);
      resetBtn.addEventListener('click', resetForm);
    });

    // Formatear como moneda
    function formatCurrency(value) {
      return new Intl.NumberFormat('es-CO').format(value);
    }

    // Formatear entrada de moneda
    function formatInputCurrency(input) {
      const value = input.value.replace(/\D/g, '');
      if (value) {
        input.value = formatCurrency(value);
      } else {
        input.value = '';
      }
    }

    // Convertir string de moneda a número
    function parseCurrency(value) {
      return parseInt(value.toString().replace(/\D/g, '')) || 0;
    }

    // Calcular monto del préstamo
    function calculateLoanAmount() {
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
      const downPayment = parseCurrency(document.getElementById('downPayment').value);
      
      let loanAmount = propertyValue - downPayment;
      if (loanAmount < 0) loanAmount = 0;
      
      document.getElementById('loanAmount').textContent = formatCurrency(loanAmount);
      
      const percentage = propertyValue > 0 ? (downPayment / propertyValue * 100).toFixed(1) : 0;
      document.getElementById('downPaymentPercentage').textContent = percentage;
    }

    // Reiniciar formulario
    function resetForm() {
      document.getElementById('propertyValue').value = '';
      document.getElementById('downPayment').value = '';
      document.getElementById('loanTerm').value = '';
      document.getElementById('loanAmount').textContent = '0';
      document.getElementById('downPaymentPercentage').textContent = '0';
      document.getElementById('resultsContainer').classList.add('d-none');
    }

    // Calcular préstamo hipotecario
    function calculateMortgage() {
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
      const downPayment = parseCurrency(document.getElementById('downPayment').value);
      const loanTerm = parseInt(document.getElementById('loanTerm').value);
      
      // Validación básica
      if (propertyValue <= 0 || downPayment <= 0 || downPayment >= propertyValue || isNaN(loanTerm)) {
        alert('Por favor, verifique los datos ingresados');
        return;
      }
      
      const loanAmount = propertyValue - downPayment;
      
      // Calcular para cada banco
      const bankResults = [];
      const mostrarSoloBogota = loanTerm > 20 && propertyValue <= 213525000;
      
      for (const bankName in banks) {
        if (mostrarSoloBogota && bankName !== "Banco de Bogotá") {
          continue;
        }
        
        const bank = banks[bankName];
        const yearlyRate = bank.rate;
        const monthlyRate = Math.pow(1 + yearlyRate, 1/12) - 1; // Tasa Mensual Vencida (MV)
        const paymentPeriods = loanTerm * 12;
        
        // Calcular pago mensual
        const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, paymentPeriods)) 
                             / (Math.pow(1 + monthlyRate, paymentPeriods) - 1);
        
        // Calcular interés total
        const totalPayment = monthlyPayment * paymentPeriods;
        const totalInterest = totalPayment - loanAmount;
        
        bankResults.push({
          bankName, logoClass: bank.logoClass, yearlyRate, monthlyRate,
          rateDescription: bank.rateDescription || "",
          monthlyPayment, totalPayment, totalInterest
        });
      }
      
      // Ordenar por pago mensual (menor primero)
      bankResults.sort((a, b) => a.monthlyPayment - b.monthlyPayment);
      
      // Mostrar resultados
      const resultsContainer = document.getElementById('resultsContainer');
      const resultsContent = document.getElementById('resultsContent');
      
      resultsContent.innerHTML = '';
      
      bankResults.forEach((result, index) => {
        const isBest = index === 0 ? '<span class="badge bg-success ms-2">Mejor opción</span>' : '';
        
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-3 mb-3 mb-md-0 text-center text-md-start">
                <i class="bi ${result.logoClass} fs-1 text-primary"></i>
                <h5 class="mb-0">${result.bankName} ${isBest}</h5>
              </div>
              <div class="col-md-3 mb-3 mb-md-0 text-center">
                <div class="text-muted">Tasas</div>
                <div class="fw-bold">${result.rateDescription} ${(result.yearlyRate * 100).toFixed(2)}% EA</div>
                <div class="text-muted">${(result.monthlyRate * 100).toFixed(2)}% MV</div>
              </div>
              <div class="col-md-3 mb-3 mb-md-0 text-center">
                <div class="text-muted">Cuota Mensual</div>
                <div class="monthly-payment">$${formatCurrency(Math.round(result.monthlyPayment))}</div>
              </div>
              <div class="col-md-3 text-center">
                <button class="btn btn-sm btn-outline-primary view-details-btn" data-bank="${result.bankName.replace(/\s+/g, '-')}">Ver detalles</button>
              </div>
            </div>
            <div class="mt-3 bank-details d-none" id="details-${result.bankName.replace(/\s+/g, '-')}">
              <div class="row">
                <div class="col-md-12">
                  <h6 class="mb-3">Detalles del Préstamo</h6>
                  <table class="table table-sm table-bordered">
                    <tr><th>Valor de la propiedad:</th><td>$${formatCurrency(propertyValue)}</td></tr>
                    <tr><th>Cuota inicial:</th><td>$${formatCurrency(downPayment)} (${(downPayment / propertyValue * 100).toFixed(1)}%)</td></tr>
                    <tr><th>Monto del crédito:</th><td>$${formatCurrency(loanAmount)}</td></tr>
                    <tr><th>Plazo:</th><td>${loanTerm} años (${loanTerm * 12} meses)</td></tr>
                    <tr><th>Tasa EA:</th><td>${result.rateDescription} ${(result.yearlyRate * 100).toFixed(2)}%</td></tr>
                    <tr><th>Tasa MV:</th><td>${(result.monthlyRate * 100).toFixed(2)}%</td></tr>
                    <tr><th>Cuota mensual:</th><td>$${formatCurrency(Math.round(result.monthlyPayment))}</td></tr>
                    <tr><th>Total a pagar:</th><td>$${formatCurrency(Math.round(result.totalPayment))}</td></tr>
                    <tr><th>Intereses totales:</th><td>$${formatCurrency(Math.round(result.totalInterest))}</td></tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
        
        resultsContent.appendChild(card);
        
        // Añadir event listener para el botón "Ver detalles"
        const detailsBtn = card.querySelector('.view-details-btn');
        detailsBtn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          const detailsSection = document.getElementById(`details-${bankId}`);
          
          if (detailsSection.classList.contains('d-none')) {
            // Cerrar todos los detalles primero
            document.querySelectorAll('.bank-details').forEach(el => {
              el.classList.add('d-none');
            });
            
            // Cambiar texto de todos los botones
            document.querySelectorAll('.view-details-btn').forEach(btn => {
              btn.textContent = 'Ver detalles';
            });
            
            // Mostrar este detalle
            detailsSection.classList.remove('d-none');
            this.textContent = 'Ocultar detalles';
          } else {
            // Ocultar detalles
            detailsSection.classList.add('d-none');
            this.textContent = 'Ver detalles';
          }
        });
      });
      
      // Generar gráfico comparativo
      generateComparisonChart(bankResults);
      
      // Generar mapa de calor de tasas
      generateInterestRateHeatMap(bankResults);
      
      resultsContainer.classList.remove('d-none');
      resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Generar gráfico comparativo de cuotas mensuales
    function generateComparisonChart(bankResults) {
      const ctx = document.getElementById('comparisonChart').getContext('2d');
      
      // Destruir gráfico existente si hay uno
      if (window.comparisonChart instanceof Chart) {
        window.comparisonChart.destroy();
      }
      
      // Preparar datos
      const labels = bankResults.map(result => result.bankName);
      const monthlyPayments = bankResults.map(result => Math.round(result.monthlyPayment));
      
      // Encontrar pago mínimo y máximo para escala personalizada
      const minPayment = Math.min(...monthlyPayments);
      const maxPayment = Math.max(...monthlyPayments);
      
      // Calcular el mínimo de la escala (90% del valor mínimo)
      const scaleMin = Math.floor(minPayment * 0.9);
      
      // Colores para las barras - graduado desde el mejor al peor
      const colors = bankResults.map((_, index) => {
        if (index === 0) return 'rgba(40, 167, 69, 0.8)'; // Verde para el mejor
        const intensity = Math.min(0.3 + (index * 0.1), 0.9); // Intensidad creciente
        return `rgba(0, 123, 255, ${intensity})`;
      });
      
      // Crear gráfico
      window.comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Cuota Mensual',
            data: monthlyPayments,
            backgroundColor: colors,
            borderColor: colors.map(color => color.replace(/[\d\.]+\)$/, '1)')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              min: scaleMin, // Comenzar la escala en un valor menor para mostrar diferencias
              ticks: {
                callback: function(value) {
                  return '$' + formatCurrency(value);
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false // Ocultar leyenda
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const diff = value - minPayment;
                  let diffText = '';
                  
                  if (context.dataIndex === 0) {
                    diffText = ' (mejor opción)';
                  } else {
                    diffText = ` (+$${formatCurrency(diff)} respecto al mejor)`;
                  }
                  
                  return 'Cuota: $' + formatCurrency(value) + diffText;
                }
              }
            }
          }
        }
      });
    }
    
    // Generar mapa de calor de tasas de interés
    function generateInterestRateHeatMap(bankResults) {
      const heatMapTable = document.getElementById('interestRateHeatMap');
      const tbody = heatMapTable.querySelector('tbody');
      
      // Limpiar tabla
      tbody.innerHTML = '';
      
      // Encontrar tasas mínima y máxima para el gradiente de colores
      const rates = bankResults.map(result => result.yearlyRate);
      const minRate = Math.min(...rates);
      const maxRate = Math.max(...rates);
      
      // Ordenar bancos por tasa (menor a mayor)
      const sortedBanks = [...bankResults].sort((a, b) => a.yearlyRate - b.yearlyRate);
      
      // Generar filas
      sortedBanks.forEach(bank => {
        const row = document.createElement('tr');
        
        // Calcular color para el mapa de calor (verde para la menor tasa, rojo para la mayor)
        const percentage = (bank.yearlyRate - minRate) / (maxRate - minRate);
        const heatColor = getHeatMapColor(percentage);
        
        row.innerHTML = `
          <td>${bank.bankName}</td>
          <td>${bank.rateDescription} ${(bank.yearlyRate * 100).toFixed(2)}%</td>
          <td>${(bank.monthlyRate * 100).toFixed(2)}%</td>
          <td>
            <div class="heat-map-cell" style="background-color: ${heatColor}; width: 100%;">
              &nbsp;
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    // Obtener color para el mapa de calor (verde para bajo, rojo para alto)
    function getHeatMapColor(percentage) {
      // Verde para 0%, rojo para 100%
      const r = Math.round(255 * percentage);
      const g = Math.round(255 * (1 - percentage));
      const b = 0;
      
      return `rgba(${r}, ${g}, ${b}, 0.7)`;
    }
  </script>
</body>
</html>
