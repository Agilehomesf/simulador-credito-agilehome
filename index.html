<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador Comparativo de Crédito Hipotecario Agile Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #020e2e;        /* Azul oscuro Agile Home */
      --primary-hover: #041c5c;        /* Azul oscuro Agile Home (hover) */
      --secondary-color: #fd4c0b;      /* Naranja Agile Home */
      --success-color: #4a4a4a;        /* Gris oscuro Agile Home */
      --light-color: #f8f9fa;          /* Gris claro */
      --dark-color: #020e2e;           /* Azul oscuro texto */
      --light-blue: #e6f0ff;           /* Azul claro para fondos */
      --whatsapp-color: #25D366;       /* Color de WhatsApp */
    }
    
    body { 
      font-family: 'Poppins', sans-serif;
      color: #4a4a4a;
      font-size: 0.9rem;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
    }
    
    .card { 
      border-radius: 10px; 
      box-shadow: 0 3px 10px rgba(0,0,0,0.05); 
      margin-bottom: 20px; 
      border-color: #e1e1e1;
      overflow: hidden;
    }
    
    .card-header {
      background-color: rgba(2, 14, 46, 0.05);
      font-weight: 600;
      color: var(--primary-color);
      padding: 0.8rem 1.25rem;
      font-size: 1rem;
    }
    
    /* Cabecera */
    header { 
      background-color: white;
      border-bottom: 1px solid #e1e1e1;
      padding: 1.5rem 0;
    }
    
    .header-title { 
      color: var(--secondary-color);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .header-subtitle {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 0;
    }
    
    /* Botones */
    .btn-primary { 
      background-color: var(--primary-color); 
      border-color: var(--primary-color);
      border-radius: 6px;
      font-weight: 500;
      padding: 0.5rem 1.5rem;
    }
    
    .btn-primary:hover { 
      background-color: var(--primary-hover); 
      border-color: var(--primary-hover);
    }
    
    .btn-success {
      background-color: var(--whatsapp-color);
      border-color: var(--whatsapp-color);
      border-radius: 6px;
      font-weight: 500;
      padding: 0.6rem 1.8rem;
    }
    
    .btn-success:hover {
      background-color: #20ba5a;
      border-color: #20ba5a;
    }
    
    .btn-outline-secondary {
      border-radius: 6px;
      font-weight: 500;
      padding: 0.5rem 1.5rem;
    }
    
    /* Cuota mensual destacada */
    .monthly-payment { 
      font-size: 1.2rem; 
      font-weight: 700; 
      color: var(--primary-color);
    }
    
    /* Mapa de calor */
    .heat-map-cell { 
      padding: 6px; 
      border-radius: 4px;
    }
    
    /* Alertas */
    .alert-info {
      background-color: var(--light-blue);
      border-color: rgba(2, 14, 46, 0.2);
      color: var(--primary-color);
      border-radius: 8px;
    }
    
    .alert-warning {
      border-radius: 8px;
    }
    
    /* Footer */
    .footer {
      background-color: var(--primary-color);
      color: white;
      padding: 2.5rem 0;
      margin-top: 2.5rem;
      font-size: 0.85rem;
    }
    
    .footer h5 {
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 1.25rem;
    }
    
    .footer ul {
      color: rgba(255, 255, 255, 0.9);
      padding-left: 1.25rem;
    }
    
    .footer p {
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 0.75rem;
    }
    
    /* Intro icons */
    .intro-icon {
      font-size: 42px;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .intro-container {
      position: relative;
      padding: 1.75rem;
      background-color: var(--light-blue);
      border-radius: 10px;
      margin-bottom: 2rem;
      overflow: hidden;
    }
    
    .house-icon-large {
      font-size: 120px;
      color: rgba(2, 14, 46, 0.07);
      position: absolute;
      right: 20px;
      bottom: 10px;
      z-index: 0;
    }
    
    /* Tabla comparativa más pequeña */
    #comparisonChart {
      max-height: 180px !important;
    }
    
    /* Selector de bancos */
    .bank-selector-item {
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      background-color: #fff;
    }
    
    .bank-selector-item:hover {
      border-color: var(--primary-color);
      background-color: rgba(2, 14, 46, 0.02);
    }
    
    .bank-selector-item.selected {
      border-color: var(--primary-color);
      background-color: rgba(2, 14, 46, 0.05);
    }
    
    .bank-selector-item .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    /* Información importante */
    .info-important {
      background-color: #1e2124;
      border-radius: 10px;
      color: #fff;
      padding: 1.5rem;
    }
    
    .info-important h5 {
      font-size: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }
    
    .info-important p {
      margin-bottom: 0.75rem;
    }
    
    .info-important ul {
      padding-left: 1.25rem;
      margin-bottom: 0;
    }
    
    .info-important li {
      margin-bottom: 0.5rem;
    }
    
    .info-important li:last-child {
      margin-bottom: 0;
    }
    
    /* Ajustes en bancos */
    .bank-card {
      transition: all 0.2s ease;
      border: 1px solid #e6e6e6;
    }
    
    .bank-card:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    
    /* Whatsapp button */
    .whatsapp-btn {
      transition: all 0.3s ease;
    }
    
    .whatsapp-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    /* Tablas */
    .table {
      font-size: 0.85rem;
    }
    
    .table th {
      font-weight: 600;
      background-color: rgba(2, 14, 46, 0.03);
    }
    
    /* Badge mejora */
    .badge-best {
      background-color: var(--secondary-color) !important;
      font-weight: 500;
      padding: 0.35em 0.65em;
    }
    
    /* Inputs */
    .form-control, .form-select {
      font-size: 0.9rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
    }
    
    .form-label {
      font-weight: 500;
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
    }
    
    /* Legal text */
    .legal-text {
      font-size: 0.75rem;
      color: #6c757d;
      margin-top: 0.75rem;
      font-style: italic;
    }
    
    /* Bank selector options mejorado */
    .bank-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .select-all-option {
      width: 100%;
      margin-bottom: 5px;
      padding: 8px 15px;
      border-radius: 8px;
      background-color: var(--light-blue);
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      border: 1px solid rgba(2, 14, 46, 0.2);
    }
    
    .select-all-option:hover {
      background-color: rgba(2, 14, 46, 0.08);
    }
    
    .bank-option {
      flex: 1 0 calc(33.333% - 10px);
      max-width: calc(33.333% - 10px);
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .bank-option:hover {
      border-color: var(--primary-color);
      background-color: rgba(2, 14, 46, 0.02);
    }
    
    .bank-option.selected {
      border-color: var(--primary-color);
      background-color: rgba(2, 14, 46, 0.05);
    }
    
    .bank-option i {
      font-size: 1.2rem;
      color: var(--primary-color);
    }
    
    @media (max-width: 768px) {
      .bank-option {
        flex: 1 0 calc(50% - 10px);
        max-width: calc(50% - 10px);
      }
    }
    
    @media (max-width: 576px) {
      .bank-option {
        flex: 1 0 100%;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header class="py-3 shadow-sm">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-2 text-center text-md-start">
          <i class="bi bi-house-heart-fill" style="font-size: 2.5rem; color: var(--secondary-color);"></i>
        </div>
        <div class="col-md-8 text-center">
          <h1 class="header-title">Simulador Comparativo de Crédito Hipotecario Agile Home</h1>
          <p class="header-subtitle">Compare opciones de préstamos hipotecarios en Colombia</p>
        </div>
        <div class="col-md-2 d-none d-md-block text-end">
          <i class="bi bi-bank" style="font-size: 2.2rem; color: var(--primary-color);"></i>
        </div>
      </div>
    </div>
  </header>

  <main class="py-4">
    <div class="container">
      <!-- Sección de introducción con iconos -->
      <div class="intro-container mb-4">
        <div class="row">
          <div class="col-md-8">
            <h3 class="mb-3" style="color: var(--primary-color); font-weight: 600; font-size: 1.4rem;">¿Sueñas con tener tu casa propia?</h3>
            <p class="mb-3">Este simulador te permite calcular y comparar cuotas mensuales de créditos hipotecarios ofrecidos por diferentes bancos en Colombia. ¡Da el primer paso hacia tu hogar ideal!</p>
            <div class="row mt-4">
              <div class="col-4 text-center">
                <i class="bi bi-house-door intro-icon"></i>
                <h6 class="mt-2" style="font-size: 0.85rem;">Ingrese el valor de la vivienda</h6>
              </div>
              <div class="col-4 text-center">
                <i class="bi bi-calculator intro-icon"></i>
                <h6 class="mt-2" style="font-size: 0.85rem;">Defina cuota inicial y plazo</h6>
              </div>
              <div class="col-4 text-center">
                <i class="bi bi-bank intro-icon"></i>
                <h6 class="mt-2" style="font-size: 0.85rem;">Compare bancos</h6>
              </div>
            </div>
          </div>
        </div>
        <i class="bi bi-houses-fill house-icon-large"></i>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-sliders me-2"></i>Información del Préstamo
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="propertyValue" class="form-label">Valor de la vivienda</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="propertyValue" placeholder="Ej. 200.000.000">
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="downPayment" class="form-label">Cuota inicial</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="downPayment" placeholder="Ej. 40.000.000">
              </div>
              <div><small class="text-muted">Equivale al <span id="downPaymentPercentage">0</span>% del valor</small></div>
            </div>
            <div class="col-12 mb-3">
              <div class="alert alert-info d-flex align-items-center py-2">
                <i class="bi bi-info-circle me-2 fs-5"></i>
                <strong>Monto a financiar: $<span id="loanAmount">0</span></strong>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="loanTerm" class="form-label">Plazo en años</label>
              <select class="form-select" id="loanTerm">
                <option value="" selected disabled>Seleccione el plazo</option>
                <option value="5">5 años</option>
                <option value="10">10 años</option>
                <option value="15">15 años</option>
                <option value="20">20 años</option>
                <option value="25">25 años</option>
                <option value="30">30 años</option>
              </select>
            </div>
          </div>
          
          <!-- Selector de bancos mejorado -->
          <div class="mt-4">
            <label class="form-label d-flex align-items-center">
              <i class="bi bi-bank me-2"></i>Seleccione los bancos a incluir en la comparación:
            </label>
            
            <div class="select-all-option" id="selectAllBanks">
              <input type="checkbox" class="form-check-input me-2" id="checkAllBanks" checked>
              <label class="form-check-label" for="checkAllBanks">Todos los bancos</label>
            </div>
            
            <div class="bank-options" id="bankOptions">
              <!-- Se llenará dinámicamente con JavaScript -->
            </div>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" id="resetBtn" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-counterclockwise me-1"></i>Reiniciar
            </button>
            <button type="button" id="calculateBtn" class="btn btn-primary">
              <i class="bi bi-calculator me-1"></i>Calcular cuotas
            </button>
          </div>
        </div>
      </div>

      <div id="resultsContainer" class="d-none">
        <div id="minCreditWarning" class="alert alert-warning d-none mb-4">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <span id="minCreditWarningText"></span>
        </div>
      
        <h3 class="mb-3" style="color: var(--primary-color); font-weight: 600; font-size: 1.3rem;">
          <i class="bi bi-graph-up me-2"></i>Resultados de la Simulación
        </h3>
        <div id="resultsContent"></div>
        
        <!-- Gráfica Comparativa (más pequeña) -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-bar-chart-fill me-2"></i>Comparativa de Cuotas Mensuales
          </div>
          <div class="card-body">
            <div style="height: 180px;">
              <canvas id="comparisonChart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Mapa de Calor de Tasas -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-grid-3x3-gap me-2"></i>Mapa de Calor de Tasas de Interés
          </div>
          <div class="card-body">
            <p class="text-muted mb-3 small">Este mapa de calor muestra visualmente qué bancos ofrecen las mejores tasas de interés. Los colores más verdes indican tasas más bajas, mientras que los colores más rojos indican tasas más altas.</p>
            <div class="table-responsive">
              <table id="interestRateHeatMap" class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Banco</th>
                    <th>Tasa EA</th>
                    <th>Tasa MV</th>
                    <th>Comparativa Visual</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Se llenará dinámicamente con JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="text-center my-4">
          <a href="https://wa.me/message/PMWO6BQHZCRSD1" target="_blank" class="btn btn-success btn-lg whatsapp-btn">
            <i class="bi bi-whatsapp me-2"></i>Contacte a un Experto
          </a>
          <p class="text-muted mt-2 small">Un asesor de Agile Home te brindará información detallada sobre tu simulación</p>
        </div>
        
        <!-- Sección legal con fondo más destacado -->
        <div id="legales" class="mt-4 info-important">
          <h5><i class="bi bi-info-circle me-2"></i>Información Importante</h5>
          <p><strong>Esta herramienta realiza estimaciones aproximadas en Pesos Colombianos (COP).</strong></p>
          <ul>
            <li>Las tasas de interés y condiciones pueden variar según la política de cada entidad financiera.</li>
            <li>La cuota mensual no incluye seguros ni otros costos asociados.</li>
            <li>La tasa definitiva aplicará según las condiciones vigentes al momento del desembolso.</li>
            <li>Para conocer el detalle de cada banco, contacta a tu asesor de Agile Home.</li>
            <li>Los valores calculados no constituyen compromiso alguno de parte del Banco y de Agile Home.</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <h5>Simulador Comparativo de Crédito Hipotecario Agile Home</h5>
          <div class="mb-0">
            <p>Esta herramienta es proporcionada por Agile Home para ayudarte a comparar opciones de financiamiento para tu nuevo hogar.</p>
            <p>Las tasas mostradas son actualizadas periódicamente y representan valores aproximados. Contacta a un asesor para información personalizada.</p>
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <p class="mb-0">© 2025 Simulador Multibanco Agile Home</p>
          <div id="lastUpdated" class="small">Tasas actualizadas: Mayo 2025</div>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Datos de los bancos con tasas actualizadas
    let banks = {
  "BBVA": { minRate: 0.1100, maxRate: 0.1597, logoClass: "bi-bank2", minLoanAmount: 6000000 },
  "Itaú": { minRate: 0.1217, maxRate: 0.1292, logoClass: "bi-building-fill", minLoanAmount: 30000000 },
  "Banco de Occidente": { minRate: 0.1070, maxRate: 0.1601, logoClass: "bi-bank", minLoanAmount: 50000000 },
  "Banco Caja Social": { minRate: 0.1100, maxRate: 0.1810, logoClass: "bi-house", minLoanAmount: 0 },
  "Credifamilia": { minRate: 0.1030, maxRate: 0.1030, logoClass: "bi-building", minLoanAmount: 0 },
  "Banco de Bogotá": { minRate: 0.1082, maxRate: 0.1228, logoClass: "bi-bank", minLoanAmount: 0 },
  "Bancolombia": { minRate: 0.1230, maxRate: 0.1370, logoClass: "bi-cash-coin", minLoanAmount: 0 }
};

    // Bancos seleccionados para la comparación (por defecto todos)
    let selectedBanks = Object.keys(banks);

    // Inicialización
    document.addEventListener('DOMContentLoaded', async function() {
      // Intentar cargar tasas desde archivo externo
      try {
        const response = await fetch('tasas_bancarias.json');
        if (response.ok) {
          const data = await response.json();
          banks = data.banks;
          
          // Mostrar fecha de actualización si existe
          if (data.lastUpdated) {
            document.getElementById('lastUpdated').textContent = `Tasas actualizadas: ${data.lastUpdated}`;
          }
        }
      } catch (error) {
        console.error('Error al cargar tasas desde archivo:', error);
        // Continuará usando los datos predeterminados definidos arriba
      }
      
      // Inicializar selector de bancos mejorado
      initBankSelector();
      
      const propertyValueInput = document.getElementById('propertyValue');
      const downPaymentInput = document.getElementById('downPayment');
      const calculateBtn = document.getElementById('calculateBtn');
      const resetBtn = document.getElementById('resetBtn');

      propertyValueInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      downPaymentInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      calculateBtn.addEventListener('click', calculateMortgage);
      resetBtn.addEventListener('click', resetForm);
    });

    // Inicializar selector de bancos mejorado
    function initBankSelector() {
      const bankOptions = document.getElementById('bankOptions');
      const selectAllCheckbox = document.getElementById('checkAllBanks');
      const selectAllOption = document.getElementById('selectAllBanks');
      
      // Limpiar opciones existentes
      bankOptions.innerHTML = '';
      
      // Crear elementos para cada banco
      Object.keys(banks).forEach(bankName => {
        const bank = banks[bankName];
        
        const bankOption = document.createElement('div');
        bankOption.className = 'bank-option selected';
        bankOption.dataset.bank = bankName;
        
        bankOption.innerHTML = `
          <input type="checkbox" class="form-check-input" id="bank-${bankName.replace(/\s+/g, '-')}" checked>
          <i class="bi ${bank.logoClass}"></i>
          <span>${bankName}</span>
        `;
        
        bankOptions.appendChild(bankOption);
        
        // Event listener para la selección de bancos
        const checkbox = bankOption.querySelector('input[type="checkbox"]');
        
        checkbox.addEventListener('change', function() {
          updateBankSelection(this, bankOption, bankName);
        });
        
        // Hacer que el clic en el div active/desactive el checkbox
        bankOption.addEventListener('click', function(e) {
          if (e.target.tagName !== 'INPUT') {
            checkbox.checked = !checkbox.checked;
            updateBankSelection(checkbox, bankOption, bankName);
          }
        });
      });
      
      // Event listener para "Todos los bancos"
      selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        
        // Actualizar todos los checkboxes individuales
        document.querySelectorAll('.bank-option input[type="checkbox"]').forEach(checkbox => {
          checkbox.checked = isChecked;
          const bankOption = checkbox.closest('.bank-option');
          const bankName = bankOption.dataset.bank;
          
          if (isChecked) {
            bankOption.classList.add('selected');
            if (!selectedBanks.includes(bankName)) {
              selectedBanks.push(bankName);
            }
          } else {
            bankOption.classList.remove('selected');
            selectedBanks = selectedBanks.filter(name => name !== bankName);
          }
        });
      });
      
      // También hacer que el clic en el div "Todos los bancos" active/desactive el checkbox
      selectAllOption.addEventListener('click', function(e) {
        if (e.target.tagName !== 'INPUT') {
          selectAllCheckbox.checked = !selectAllCheckbox.checked;
          selectAllCheckbox.dispatchEvent(new Event('change'));
        }
      });
    }
    
    // Actualizar selección de banco
    function updateBankSelection(checkbox, bankOption, bankName) {
      if (checkbox.checked) {
        bankOption.classList.add('selected');
        if (!selectedBanks.includes(bankName)) {
          selectedBanks.push(bankName);
        }
      } else {
        bankOption.classList.remove('selected');
        selectedBanks = selectedBanks.filter(name => name !== bankName);
      }
      
      // Actualizar el estado del checkbox "Todos los bancos"
      const allBanks = Object.keys(banks);
      const selectAllCheckbox = document.getElementById('checkAllBanks');
      
      if (selectedBanks.length === allBanks.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedBanks.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else {
        selectAllCheckbox.indeterminate = true;
      }
    }

    // Formatear como moneda
    function formatCurrency(value) {
      return new Intl.NumberFormat('es-CO').format(value);
    }

    // Formatear entrada de moneda
    function formatInputCurrency(input) {
      const value = input.value.replace(/\D/g, '');
      if (value) {
        input.value = formatCurrency(value);
      } else {
        input.value = '';
      }
    }

    // Convertir string de moneda a número
    function parseCurrency(value) {
      return parseInt(value.toString().replace(/\D/g, '')) || 0;
    }

    // Calcular monto del préstamo
    function calculateLoanAmount() {
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
      const downPayment = parseCurrency(document.getElementById('downPayment').value);
      
      let loanAmount = propertyValue - downPayment;
      if (loanAmount < 0) loanAmount = 0;
      
      document.getElementById('loanAmount').textContent = formatCurrency(loanAmount);
      
      const percentage = propertyValue > 0 ? (downPayment / propertyValue * 100).toFixed(1) : 0;
      document.getElementById('downPaymentPercentage').textContent = percentage;
    }

    // Reiniciar formulario
    function resetForm() {
      document.getElementById('propertyValue').value = '';
      document.getElementById('downPayment').value = '';
      document.getElementById('loanTerm').value = '';
      document.getElementById('loanAmount').textContent = '0';
      document.getElementById('downPaymentPercentage').textContent = '0';
      document.getElementById('resultsContainer').classList.add('d-none');
      document.getElementById('minCreditWarning').classList.add('d-none');
      
      // Reiniciar selección de bancos
      selectedBanks = Object.keys(banks);
      
      // Marcar todas las opciones
      const selectAllCheckbox = document.getElementById('checkAllBanks');
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
      
      document.querySelectorAll('.bank-option').forEach(option => {
        option.classList.add('selected');
        const checkbox = option.querySelector('input[type="checkbox"]');
        checkbox.checked = true;
      });
    }

    // Calcular préstamo hipotecario
    function calculateMortgage() {
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
  const downPayment = parseCurrency(document.getElementById('downPayment').value);
  const loanTerm = parseInt(document.getElementById('loanTerm').value);

  if (propertyValue <= 0 || downPayment <= 0 || downPayment >= propertyValue || isNaN(loanTerm)) {
    alert('Por favor, verifique los datos ingresados');
    return;
  }

  if (selectedBanks.length === 0) {
    alert('Debe seleccionar al menos un banco para la comparación');
    return;
  }

  const loanAmount = propertyValue - downPayment;

  const resultsContent = document.getElementById('resultsContent');
  const resultsContainer = document.getElementById('resultsContainer');
  resultsContent.innerHTML = '';
  resultsContainer.classList.remove('d-none');

  let allResults = [];

  selectedBanks.forEach(bankName => {
    const bank = banks[bankName];

    ["minRate", "maxRate"].forEach(rateType => {
      const yearlyRate = bank[rateType];
      if (!yearlyRate) return;

      const monthlyRate = Math.pow(1 + yearlyRate, 1 / 12) - 1;
      const paymentPeriods = loanTerm * 12;
      const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, paymentPeriods)) /
                              (Math.pow(1 + monthlyRate, paymentPeriods) - 1);

      allResults.push({
        bankName,
        logoClass: bank.logoClass,
        yearlyRate,
        monthlyRate,
        rateLabel: rateType === "minRate" ? "Tasa más baja" : "Tasa más alta",
        monthlyPayment
      });
    });
  });

  allResults.sort((a, b) => a.monthlyPayment - b.monthlyPayment);

  allResults.forEach((result, index) => {
    const isBest = index === 0 ? '<span class="badge badge-best ms-2">Mejor opción</span>' : '';
    const card = document.createElement('div');
    card.className = 'card mb-3 bank-card';
    card.innerHTML = `
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-3 text-center text-md-start">
            <i class="bi ${result.logoClass} fs-1 text-primary"></i>
            <h5 class="mb-0">${result.bankName} ${isBest}</h5>
          </div>
          <div class="col-md-3 text-center">
            <div class="text-muted small">${result.rateLabel}</div>
            <div class="fw-bold">${(result.yearlyRate * 100).toFixed(2)}% EA</div>
            <div class="text-muted small">${(result.monthlyRate * 100).toFixed(2)}% MV</div>
          </div>
          <div class="col-md-3 text-center">
            <div class="text-muted small">Cuota Mensual</div>
            <div class="monthly-payment">$${formatCurrency(Math.round(result.monthlyPayment))}</div>
          </div>
          <div class="col-md-3 text-center">
            <button class="btn btn-sm btn-outline-primary view-details-btn" data-rate="${result.rateLabel}" data-bank="${result.bankName.replace(/\s+/g, '-')}-${result.rateLabel.replace(/\s+/g, '-')}">
              <i class="bi bi-eye me-1"></i>Ver detalles
            </button>
          </div>
        </div>
        <div class="mt-3 bank-details d-none" id="details-${result.bankName.replace(/\s+/g, '-')}-${result.rateLabel.replace(/\s+/g, '-')}">
          <h6 class="mb-3 fw-bold small">Detalles del Préstamo</h6>
          <table class="table table-sm table-bordered">
            <tr><th>Valor de la propiedad:</th><td>$${formatCurrency(propertyValue)}</td></tr>
            <tr><th>Cuota inicial:</th><td>$${formatCurrency(downPayment)} (${(downPayment / propertyValue * 100).toFixed(1)}%)</td></tr>
            <tr><th>Monto del crédito:</th><td>$${formatCurrency(loanAmount)}</td></tr>
            <tr><th>Plazo:</th><td>${loanTerm} años (${loanTerm * 12} meses)</td></tr>
            <tr><th>${result.rateLabel} (EA):</th><td>${(result.yearlyRate * 100).toFixed(2)}%</td></tr>
            <tr><th>Tasa MV:</th><td>${(result.monthlyRate * 100).toFixed(2)}%</td></tr>
            <tr><th>Cuota mensual:</th><td>$${formatCurrency(Math.round(result.monthlyPayment))}</td></tr>
          </table>
          <p class="legal-text">* Cálculos con tasas vigentes. Esta simulación no constituye compromiso para el banco ni para Agile Home.</p>
        </div>
      </div>
    `;

    resultsContent.appendChild(card);

    const detailsBtn = card.querySelector('.view-details-btn');
    detailsBtn.addEventListener('click', function () {
      const id = this.getAttribute('data-bank');
      const detailsSection = document.getElementById(`details-${id}`);
      const allSections = document.querySelectorAll('.bank-details');

      allSections.forEach(el => el.classList.add('d-none'));
      document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.innerHTML = '<i class="bi bi-eye me-1"></i>Ver detalles';
      });

      if (detailsSection.classList.contains('d-none')) {
        detailsSection.classList.remove('d-none');
        this.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Ocultar detalles';
      } else {
        detailsSection.classList.add('d-none');
        this.innerHTML = '<i class="bi bi-eye me-1"></i>Ver detalles';
      }
    });
  });

  // ACTUALIZA GRÁFICOS
  generateComparisonChart(allResults);
  generateInterestRateHeatMap(allResults);
}

    // Generar mapa de calor de tasas de interés
   const ctx = document.getElementById('comparisonChart').getContext('2d');
  if (window.comparisonChart instanceof Chart) window.comparisonChart.destroy();

  const labels = results.map(r => `${r.bankName} - ${r.rateLabel}`);
  const payments = results.map(r => Math.round(r.monthlyPayment));
  const minPayment = Math.min(...payments);

  const colors = results.map((r, i) =>
    payments[i] === minPayment ? 'rgba(253, 76, 11, 0.9)' : 'rgba(2, 14, 46, 0.7)'
  );

  window.comparisonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Cuota Mensual',
        data: payments,
        backgroundColor: colors,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          ticks: {
            callback: value => '$' + formatCurrency(value)
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => 'Cuota: $' + formatCurrency(context.raw)
          }
        }
      }
    }
  });
}

function getHeatMapColor(pct) {
  if (pct < 0.2) return 'rgba(40, 167, 69, 0.7)';
  if (pct < 0.5) return `rgba(${40 + pct * 2 * 215}, 167, 69, 0.7)`;
  if (pct < 0.8) return `rgba(${215 + pct * 40}, ${167 - pct * 167}, 0, 0.7)`;
  return 'rgba(253, ' + Math.round(76 * (1 - pct)) + ', 11, 0.7)';
}

function generateInterestRateHeatMap(results) {
  const tbody = document.querySelector('#interestRateHeatMap tbody');
  tbody.innerHTML = '';
  const rates = results.map(r => r.yearlyRate);
  const minRate = Math.min(...rates), maxRate = Math.max(...rates);
  const sorted = [...results].sort((a, b) => a.yearlyRate - b.yearlyRate);

  sorted.forEach(bank => {
    const pct = (bank.yearlyRate - minRate) / (maxRate - minRate || 1);
    const heatColor = getHeatMapColor(pct);
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><i class="bi ${bank.logoClass} me-2"></i>${bank.bankName} (${bank.rateLabel})</td>
      <td>${(bank.yearlyRate * 100).toFixed(2)}%</td>
      <td>${(bank.monthlyRate * 100).toFixed(2)}%</td>
      <td><div class="heat-map-cell" style="background-color: ${heatColor}; width: 100%;">&nbsp;</div></td>
    `;
    tbody.appendChild(row);
  });
}
