<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador Comparativo de Crédito Hipotecario Agile Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #020e2e;        /* Azul oscuro Agile Home */
      --primary-hover: #041c5c;        /* Azul oscuro Agile Home (hover) */
      --secondary-color: #fd4c0b;      /* Naranja Agile Home */
      --success-color: #4a4a4a;        /* Gris oscuro Agile Home */
      --light-color: #f8f9fa;          /* Gris claro */
      --dark-color: #020e2e;           /* Azul oscuro texto */
      --light-blue: #e6f0ff;           /* Azul claro para fondos */
    }
    
    body { 
      font-family: 'Poppins', sans-serif;
      color: #4a4a4a;
      font-size: 0.9rem;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
    }
    
    .card { 
      border-radius: 10px; 
      box-shadow: 0 3px 10px rgba(0,0,0,0.05); 
      margin-bottom: 20px; 
      border-color: #e1e1e1;
      overflow: hidden;
    }
    
    .card-header {
      background-color: rgba(2, 14, 46, 0.05);
      font-weight: 600;
      color: var(--primary-color);
      padding: 0.8rem 1.25rem;
      font-size: 1rem;
    }
    
    /* Cabecera */
    header { 
      background-color: white;
      border-bottom: 1px solid #e1e1e1;
      padding: 1.5rem 0;
    }
    
    .header-title { 
      color: var(--secondary-color);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .header-subtitle {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 0;
    }
    
    /* Botones */
    .btn-primary { 
      background-color: var(--primary-color); 
      border-color: var(--primary-color);
      border-radius: 6px;
      font-weight: 500;
      padding: 0.5rem 1.5rem;
    }
    
    .btn-primary:hover { 
      background-color: var(--primary-hover); 
      border-color: var(--primary-hover);
    }
    
    .btn-success {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      border-radius: 6px;
      font-weight: 500;
      padding: 0.6rem 1.8rem;
    }
    
    .btn-success:hover {
      background-color: #e1430a;
      border-color: #e1430a;
    }
    
    .btn-outline-secondary {
      border-radius: 6px;
      font-weight: 500;
      padding: 0.5rem 1.5rem;
    }
    
    /* Cuota mensual destacada */
    .monthly-payment { 
      font-size: 1.2rem; 
      font-weight: 700; 
      color: var(--primary-color);
    }
    
    /* Mapa de calor */
    .heat-map-cell { 
      padding: 6px; 
      border-radius: 4px;
    }
    
    /* Alertas */
    .alert-info {
      background-color: var(--light-blue);
      border-color: rgba(2, 14, 46, 0.2);
      color: var(--primary-color);
      border-radius: 8px;
    }
    
    /* Footer */
    .footer {
      background-color: var(--primary-color);
      color: white;
      padding: 2.5rem 0;
      margin-top: 2.5rem;
      font-size: 0.85rem;
    }
    
    .footer h5 {
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 1.25rem;
    }
    
    .footer ul {
      color: rgba(255, 255, 255, 0.9);
      padding-left: 1.25rem;
    }
    
    .footer p {
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 0.75rem;
    }
    
    /* Intro icons */
    .intro-icon {
      font-size: 42px;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .intro-container {
      position: relative;
      padding: 1.75rem;
      background-color: var(--light-blue);
      border-radius: 10px;
      margin-bottom: 2rem;
      overflow: hidden;
    }
    
    .house-icon-large {
      font-size: 120px;
      color: rgba(2, 14, 46, 0.07);
      position: absolute;
      right: 20px;
      bottom: 10px;
      z-index: 0;
    }
    
    /* Tabla comparativa más pequeña */
    #comparisonChart {
      max-height: 180px !important;
    }
    
    /* Selector de bancos */
    .bank-selector-item {
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      background-color: #fff;
    }
    
    .bank-selector-item:hover {
      border-color: var(--primary-color);
      background-color: rgba(2, 14, 46, 0.02);
    }
    
    .bank-selector-item.selected {
      border-color: var(--primary-color);
      background-color: rgba(2, 14, 46, 0.05);
    }
    
    .bank-selector-item .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    /* Información importante */
    .info-important {
      background-color: #1e2124;
      border-radius: 10px;
      color: #fff;
      padding: 1.5rem;
    }
    
    .info-important h5 {
      font-size: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }
    
    .info-important p {
      margin-bottom: 0.75rem;
    }
    
    .info-important ul {
      padding-left: 1.25rem;
      margin-bottom: 0;
    }
    
    .info-important li {
      margin-bottom: 0.5rem;
    }
    
    .info-important li:last-child {
      margin-bottom: 0;
    }
    
    /* Ajustes en bancos */
    .bank-card {
      transition: all 0.2s ease;
      border: 1px solid #e6e6e6;
    }
    
    .bank-card:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    
    /* Whatsapp button */
    .whatsapp-btn {
      transition: all 0.3s ease;
    }
    
    .whatsapp-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    /* Tablas */
    .table {
      font-size: 0.85rem;
    }
    
    .table th {
      font-weight: 600;
      background-color: rgba(2, 14, 46, 0.03);
    }
    
    /* Badge mejora */
    .badge-best {
      background-color: var(--secondary-color) !important;
      font-weight: 500;
      padding: 0.35em 0.65em;
    }
    
    /* Inputs */
    .form-control, .form-select {
      font-size: 0.9rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
    }
    
    .form-label {
      font-weight: 500;
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
    }
  </style>
</head>
<body>
  <header class="py-3 shadow-sm">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-2 text-center text-md-start">
          <i class="bi bi-house-heart-fill" style="font-size: 2.5rem; color: var(--secondary-color);"></i>
        </div>
        <div class="col-md-8 text-center">
          <h1 class="header-title">Simulador Comparativo de Crédito Hipotecario Agile Home</h1>
          <p class="header-subtitle">Compare opciones de préstamos hipotecarios en Colombia</p>
        </div>
        <div class="col-md-2 d-none d-md-block text-end">
          <i class="bi bi-bank" style="font-size: 2.2rem; color: var(--primary-color);"></i>
        </div>
      </div>
    </div>
  </header>

  <main class="py-4">
    <div class="container">
      <!-- Sección de introducción con iconos -->
      <div class="intro-container mb-4">
        <div class="row">
          <div class="col-md-8">
            <h3 class="mb-3" style="color: var(--primary-color); font-weight: 600; font-size: 1.4rem;">¿Sueñas con tener tu casa propia?</h3>
            <p class="mb-3">Este simulador te permite calcular y comparar cuotas mensuales de créditos hipotecarios ofrecidos por diferentes bancos en Colombia. ¡Da el primer paso hacia tu hogar ideal!</p>
            <div class="row mt-4">
              <div class="col-4 text-center">
                <i class="bi bi-house-door intro-icon"></i>
                <h6 class="mt-2" style="font-size: 0.85rem;">Ingrese el valor de la vivienda</h6>
              </div>
              <div class="col-4 text-center">
                <i class="bi bi-calculator intro-icon"></i>
                <h6 class="mt-2" style="font-size: 0.85rem;">Defina cuota inicial y plazo</h6>
              </div>
              <div class="col-4 text-center">
                <i class="bi bi-bank intro-icon"></i>
                <h6 class="mt-2" style="font-size: 0.85rem;">Compare bancos</h6>
              </div>
            </div>
          </div>
        </div>
        <i class="bi bi-houses-fill house-icon-large"></i>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-sliders me-2"></i>Información del Préstamo
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="propertyValue" class="form-label">Valor de la vivienda</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="propertyValue" placeholder="Ej. 200.000.000">
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="downPayment" class="form-label">Cuota inicial</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="downPayment" placeholder="Ej. 40.000.000">
              </div>
              <div><small class="text-muted">Equivale al <span id="downPaymentPercentage">0</span>% del valor</small></div>
            </div>
            <div class="col-12 mb-3">
              <div class="alert alert-info d-flex align-items-center py-2">
                <i class="bi bi-info-circle me-2 fs-5"></i>
                <strong>Monto a financiar: $<span id="loanAmount">0</span></strong>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="loanTerm" class="form-label">Plazo en años</label>
              <select class="form-select" id="loanTerm">
                <option value="" selected disabled>Seleccione el plazo</option>
                <option value="5">5 años</option>
                <option value="10">10 años</option>
                <option value="15">15 años</option>
                <option value="20">20 años</option>
                <option value="25">25 años</option>
                <option value="30">30 años</option>
              </select>
            </div>
          </div>
          
          <!-- Selector de bancos -->
          <div class="mt-4">
            <label class="form-label d-flex align-items-center">
              <i class="bi bi-bank me-2"></i>Seleccione los bancos a incluir en la comparación:
            </label>
            <div class="row" id="bankSelector">
              <!-- Se llenará dinámicamente con JavaScript -->
            </div>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" id="resetBtn" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-counterclockwise me-1"></i>Reiniciar
            </button>
            <button type="button" id="calculateBtn" class="btn btn-primary">
              <i class="bi bi-calculator me-1"></i>Calcular cuotas
            </button>
          </div>
        </div>
      </div>

      <div id="resultsContainer" class="d-none">
        <h3 class="mb-3" style="color: var(--primary-color); font-weight: 600; font-size: 1.3rem;">
          <i class="bi bi-graph-up me-2"></i>Resultados de la Simulación
        </h3>
        <div id="resultsContent"></div>
        
        <!-- Gráfica Comparativa (más pequeña) -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-bar-chart-fill me-2"></i>Comparativa de Cuotas Mensuales
          </div>
          <div class="card-body">
            <div style="height: 180px;">
              <canvas id="comparisonChart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Mapa de Calor de Tasas -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-grid-3x3-gap me-2"></i>Mapa de Calor de Tasas de Interés
          </div>
          <div class="card-body">
            <p class="text-muted mb-3 small">Este mapa de calor muestra visualmente qué bancos ofrecen las mejores tasas de interés. Los colores más verdes indican tasas más bajas, mientras que los colores más rojos indican tasas más altas.</p>
            <div class="table-responsive">
              <table id="interestRateHeatMap" class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Banco</th>
                    <th>Tasa EA</th>
                    <th>Tasa MV</th>
                    <th>Comparativa Visual</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Se llenará dinámicamente con JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="text-center my-4">
          <a href="https://wa.me/message/PMWO6BQHZCRSD1" target="_blank" class="btn btn-success btn-lg whatsapp-btn">
            <i class="bi bi-whatsapp me-2"></i>Contactar asesor por WhatsApp
          </a>
          <p class="text-muted mt-2 small">Un asesor de Agile Home te brindará información detallada sobre tu simulación</p>
        </div>
        
        <!-- Sección legal con fondo más destacado -->
        <div id="legales" class="mt-4 info-important">
          <h5><i class="bi bi-info-circle me-2"></i>Información Importante</h5>
          <p><strong>Esta herramienta realiza estimaciones aproximadas en Pesos Colombianos (COP).</strong></p>
          <ul>
            <li>Las tasas de interés y condiciones pueden variar según la política de cada entidad financiera.</li>
            <li>La cuota mensual no incluye seguros ni otros costos asociados.</li>
            <li>La tasa definitiva aplicará según las condiciones vigentes al momento del desembolso.</li>
            <li>Para conocer el detalle de cada banco, contacta a tu asesor de Agile Home.</li>
            <li>Los valores calculados no constituyen compromiso alguno de parte del Banco y de Agile Home.</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <h5>Simulador Comparativo de Crédito Hipotecario Agile Home</h5>
          <div class="mb-0">
            <p>Esta herramienta es proporcionada por Agile Home para ayudarte a comparar opciones de financiamiento para tu nuevo hogar.</p>
            <p>Las tasas mostradas son actualizadas periódicamente y representan valores aproximados. Contacta a un asesor para información personalizada.</p>
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <p class="mb-0">© 2025 Simulador Multibanco Agile Home</p>
          <div id="lastUpdated" class="small">Tasas actualizadas: Mayo 2025</div>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Datos de los bancos con tasas actualizadas
    let banks = {
      "BBVA": { 
        rate: 0.1102, 
        rateDescription: "Desde", 
        logoClass: "bi-bank2" 
      },
      "Itaú": { 
        rate: 0.1259, 
        rateDescription: "Desde", 
        logoClass: "bi-building-fill" 
      },
      "Banco de Occidente": { 
        rate: 0.1088, 
        rateDescription: "Desde", 
        logoClass: "bi-bank" 
      },
      "Banco Caja Social": { 
        rate: 0.11, 
        rateDescription: "Desde", 
        logoClass: "bi-house" 
      },
      "Credifamilia": { 
        rate: 0.107, 
        rateDescription: "Desde", 
        logoClass: "bi-building" 
      },
      "Banco de Bogotá": { 
        rate: 0.1082, 
        rateDescription: "Desde", 
        logoClass: "bi-bank" 
      }
    };

    // Bancos seleccionados para la comparación (por defecto todos)
    let selectedBanks = Object.keys(banks);

    // Inicialización
    document.addEventListener('DOMContentLoaded', async function() {
      // Intentar cargar tasas desde archivo externo
      try {
        const response = await fetch('tasas_bancarias.json');
        if (response.ok) {
          const data = await response.json();
          banks = data.banks;
          
          // Mostrar fecha de actualización si existe
          if (data.lastUpdated) {
            document.getElementById('lastUpdated').textContent = `Tasas actualizadas: ${data.lastUpdated}`;
          }
        }
      } catch (error) {
        console.error('Error al cargar tasas desde archivo:', error);
        // Continuará usando los datos predeterminados definidos arriba
      }
      
      // Inicializar selector de bancos
      initBankSelector();
      
      const propertyValueInput = document.getElementById('propertyValue');
      const downPaymentInput = document.getElementById('downPayment');
      const calculateBtn = document.getElementById('calculateBtn');
      const resetBtn = document.getElementById('resetBtn');

      propertyValueInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      downPaymentInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      calculateBtn.addEventListener('click', calculateMortgage);
      resetBtn.addEventListener('click', resetForm);
    });

    // Inicializar selector de bancos
    function initBankSelector() {
      const bankSelector = document.getElementById('bankSelector');
      bankSelector.innerHTML = '';
      
      // Crear elementos de selección para cada banco
      Object.keys(banks).forEach(bankName => {
        const bank = banks[bankName];
        
        const col = document.createElement('div');
        col.className = 'col-md-4 col-sm-6 mb-2';
        
        const item = document.createElement('div');
        item.className = 'bank-selector-item selected';
        item.dataset.bank = bankName;
        
        item.innerHTML = `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="bank-${bankName.replace(/\s+/g, '-')}" checked>
            <label class="form-check-label d-flex align-items-center" for="bank-${bankName.replace(/\s+/g, '-')}">
              <i class="bi ${bank.logoClass} me-2"></i>
              <span>${bankName}</span>
              <span class="badge bg-light text-dark ms-auto">${(bank.rate * 100).toFixed(2)}%</span>
            </label>
          </div>
        `;
        
        col.appendChild(item);
        bankSelector.appendChild(col);
        
        // Event listener para la selección de bancos
        const checkbox = item.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            item.classList.add('selected');
            if (!selectedBanks.includes(bankName)) {
              selectedBanks.push(bankName);
            }
          } else {
            item.classList.remove('selected');
            selectedBanks = selectedBanks.filter(name => name !== bankName);
          }
        });
        
        // También hacer que el clic en el div active/desactive el checkbox
        item.addEventListener('click', function(e) {
          if (e.target.tagName !== 'INPUT') {
            checkbox.checked = !checkbox.checked;
            
            // Disparar evento change manualmente
            const event = new Event('change');
            checkbox.dispatchEvent(event);
          }
        });
      });
    }

    // Formatear como moneda
    function formatCurrency(value) {
      return new Intl.NumberFormat('es-CO').format(value);
    }

    // Formatear entrada de moneda
    function formatInputCurrency(input) {
      const value = input.value.replace(/\D/g, '');
      if (value) {
        input.value = formatCurrency(value);
      } else {
        input.value = '';
      }
    }

    // Convertir string de moneda a número
    function parseCurrency(value) {
      return parseInt(value.toString().replace(/\D/g, '')) || 0;
    }

    // Calcular monto del préstamo
    function calculateLoanAmount() {
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
      const downPayment = parseCurrency(document.getElementById('downPayment').value);
      
      let loanAmount = propertyValue - downPayment;
      if (loanAmount < 0) loanAmount = 0;
      
      document.getElementById('loanAmount').textContent = formatCurrency(loanAmount);
      
      const percentage = propertyValue > 0 ? (downPayment / propertyValue * 100).toFixed(1) : 0;
      document.getElementById('downPaymentPercentage').textContent = percentage;
    }

    // Reiniciar formulario
    function resetForm() {
      document.getElementById('propertyValue').value = '';
      document.getElementById('downPayment').value = '';
      document.getElementById('loanTerm').value = '';
      document.getElementById('loanAmount').textContent = '0';
      document.getElementById('downPaymentPercentage').textContent = '0';
      document.getElementById('resultsContainer').classList.add('d-none');
      
      // Reiniciar selección de bancos
      selectedBanks = Object.keys(banks);
      document.querySelectorAll('#bankSelector input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
        checkbox.closest('.bank-selector-item').classList.add('selected');
      });
    }

    // Calcular préstamo hipotecario
    function calculateMortgage() {
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
      const downPayment = parseCurrency(document.getElementById('downPayment').value);
      const loanTerm = parseInt(document.getElementById('loanTerm').value);
      
      // Validación básica
      if (propertyValue <= 0 || downPayment <= 0 || downPayment >= propertyValue || isNaN(loanTerm)) {
        alert('Por favor, verifique los datos ingresados');
        return;
      }
      
      // Validar que al menos un banco esté seleccionado
      if (selectedBanks.length === 0) {
        alert('Debe seleccionar al menos un banco para la comparación');
        return;
      }
      
      const loanAmount = propertyValue - downPayment;
      
      // Calcular para cada banco seleccionado
      const bankResults = [];
      const mostrarSoloBogota = loanTerm > 20 && propertyValue <= 213525000;
      
      for (const bankName of selectedBanks) {
        if (mostrarSoloBogota && bankName !== "Banco de Bogotá") {
          continue;
        }
        
        const bank = banks[bankName];
        const yearlyRate = bank.rate;
        const monthlyRate = Math.pow(1 + yearlyRate, 1/12) - 1; // Tasa Mensual Vencida (MV)
        const paymentPeriods = loanTerm * 12;
        
        // Calcular pago mensual
        const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, paymentPeriods)) 
                             / (Math.pow(1 + monthlyRate, paymentPeriods) - 1);
        
        bankResults.push({
          bankName, logoClass: bank.logoClass, yearlyRate, monthlyRate,
          rateDescription: bank.rateDescription || "",
          monthlyPayment
        });
      }
      
      // Ordenar por pago mensual (menor primero)
      bankResults.sort((a, b) => a.monthlyPayment - b.monthlyPayment);
      
      // Mostrar resultados
      const resultsContainer = document.getElementById('resultsContainer');
      const resultsContent = document.getElementById('resultsContent');
      
      resultsContent.innerHTML = '';
      
      if (bankResults.length === 0) {
        resultsContent.innerHTML = '<div class="alert alert-warning">No hay resultados disponibles con los criterios seleccionados.</div>';
        resultsContainer.classList.remove('d-none');
        return;
      }
      
      bankResults.forEach((result, index) => {
        const isBest = index === 0 ? '<span class="badge badge-best ms-2">Mejor opción</span>' : '';
        
        const card = document.createElement('div');
        card.className = 'card mb-3 bank-card';
        card.innerHTML = `
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-3 mb-3 mb-md-0 text-center text-md-start">
                <i class="bi ${result.logoClass} fs-1 text-primary"></i>
                <h5 class="mb-0">${result.bankName} ${isBest}</h5>
              </div>
              <div class="col-md-3 mb-3 mb-md-0 text-center">
                <div class="text-muted small">Tasas</div>
                <div class="fw-bold">${result.rateDescription} ${(result.yearlyRate * 100).toFixed(2)}% EA</div>
                <div class="text-muted small">${(result.monthlyRate * 100).toFixed(2)}% MV</div>
              </div>
              <div class="col-md-3 mb-3 mb-md-0 text-center">
                <div class="text-muted small">Cuota Mensual</div>
                <div class="monthly-payment">$${formatCurrency(Math.round(result.monthlyPayment))}</div>
              </div>
              <div class="col-md-3 text-center">
                <button class="btn btn-sm btn-outline-primary view-details-btn" data-bank="${result.bankName.replace(/\s+/g, '-')}">
                  <i class="bi bi-eye me-1"></i>Ver detalles
                </button>
              </div>
            </div>
            <div class="mt-3 bank-details d-none" id="details-${result.bankName.replace(/\s+/g, '-')}">
              <div class="row">
                <div class="col-md-12">
                  <h6 class="mb-3 fw-bold small">Detalles del Préstamo</h6>
                  <table class="table table-sm table-bordered">
                    <tr><th>Valor de la propiedad:</th><td>$${formatCurrency(propertyValue)}</td></tr>
                    <tr><th>Cuota inicial:</th><td>$${formatCurrency(downPayment)} (${(downPayment / propertyValue * 100).toFixed(1)}%)</td></tr>
                    <tr><th>Monto del crédito:</th><td>$${formatCurrency(loanAmount)}</td></tr>
                    <tr><th>Plazo:</th><td>${loanTerm} años (${loanTerm * 12} meses)</td></tr>
                    <tr><th>Tasa EA:</th><td>${result.rateDescription} ${(result.yearlyRate * 100).toFixed(2)}%</td></tr>
                    <tr><th>Tasa MV:</th><td>${(result.monthlyRate * 100).toFixed(2)}%</td></tr>
                    <tr><th>Cuota mensual:</th><td>$${formatCurrency(Math.round(result.monthlyPayment))}</td></tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
        
        resultsContent.appendChild(card);
        
        // Añadir event listener para el botón "Ver detalles"
        const detailsBtn = card.querySelector('.view-details-btn');
        detailsBtn.addEventListener('click', function() {
          const bankId = this.getAttribute('data-bank');
          const detailsSection = document.getElementById(`details-${bankId}`);
          
          if (detailsSection.classList.contains('d-none')) {
            // Cerrar todos los detalles primero
            document.querySelectorAll('.bank-details').forEach(el => {
              el.classList.add('d-none');
            });
            
            // Cambiar texto de todos los botones
            document.querySelectorAll('.view-details-btn').forEach(btn => {
              btn.innerHTML = '<i class="bi bi-eye me-1"></i>Ver detalles';
            });
            
            // Mostrar este detalle
            detailsSection.classList.remove('d-none');
            this.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Ocultar detalles';
          } else {
            // Ocultar detalles
            detailsSection.classList.add('d-none');
            this.innerHTML = '<i class="bi bi-eye me-1"></i>Ver detalles';
          }
        });
      });
      
      // Generar gráfico comparativo
      generateComparisonChart(bankResults);
      
      // Generar mapa de calor de tasas
      generateInterestRateHeatMap(bankResults);
      
      resultsContainer.classList.remove('d-none');
      resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Generar gráfico comparativo de cuotas mensuales
    function generateComparisonChart(bankResults) {
      const ctx = document.getElementById('comparisonChart').getContext('2d');
      
      // Destruir gráfico existente si hay uno
      if (window.comparisonChart instanceof Chart) {
        window.comparisonChart.destroy();
      }
      
      // Preparar datos
      const labels = bankResults.map(result => result.bankName);
      const monthlyPayments = bankResults.map(result => Math.round(result.monthlyPayment));
      
      // Encontrar pago mínimo y máximo para escala personalizada
      const minPayment = Math.min(...monthlyPayments);
      const maxPayment = Math.max(...monthlyPayments);
      
      // Calcular el mínimo de la escala (90% del valor mínimo)
      const scaleMin = Math.floor(minPayment * 0.9);
      
      // Colores para las barras - graduado desde el mejor al peor
      const colors = bankResults.map((_, index) => {
        if (index === 0) return 'rgba(253, 76, 11, 0.8)'; // Naranja Agile Home para el mejor
        const intensity = Math.min(0.3 + (index * 0.1), 0.9); // Intensidad creciente
        return `rgba(2, 14, 46, ${intensity})`; // Azul Agile Home para el resto
      });
      
      // Crear gráfico
      window.comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Cuota Mensual',
            data: monthlyPayments,
            backgroundColor: colors,
            borderColor: colors.map(color => color.replace(/[\d\.]+\)$/, '1)')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: scaleMin, // Comenzar la escala en un valor menor para mostrar diferencias
              ticks: {
                callback: function(value) {
                  return '$' + formatCurrency(value);
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false // Ocultar leyenda
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const diff = value - minPayment;
                  let diffText = '';
                  
                  if (context.dataIndex === 0) {
                    diffText = ' (mejor opción)';
                  } else {
                    diffText = ` (+$${formatCurrency(diff)} respecto al mejor)`;
                  }
                  
                  return 'Cuota: $' + formatCurrency(value) + diffText;
                }
              }
            }
          }
        }
      });
    }
    
    // Generar mapa de calor de tasas de interés
    function generateInterestRateHeatMap(bankResults) {
      const heatMapTable = document.getElementById('interestRateHeatMap');
      const tbody = heatMapTable.querySelector('tbody');
      
      // Limpiar tabla
      tbody.innerHTML = '';
      
      // Encontrar tasas mínima y máxima para el gradiente de colores
      const rates = bankResults.map(result => result.yearlyRate);
      const minRate = Math.min(...rates);
      const maxRate = Math.max(...rates);
      
      // Ordenar bancos por tasa (menor a mayor)
      const sortedBanks = [...bankResults].sort((a, b) => a.yearlyRate - b.yearlyRate);
      
      // Generar filas
      sortedBanks.forEach(bank => {
        const row = document.createElement('tr');
        
        // Calcular color para el mapa de calor (verde para la menor tasa, rojo para la mayor)
        const percentage = (bank.yearlyRate - minRate) / (maxRate - minRate);
        const heatColor = getHeatMapColor(percentage);
        
        row.innerHTML = `
          <td><i class="bi ${bank.logoClass} me-2"></i>${bank.bankName}</td>
          <td>${bank.rateDescription} ${(bank.yearlyRate * 100).toFixed(2)}%</td>
          <td>${(bank.monthlyRate * 100).toFixed(2)}%</td>
          <td>
            <div class="heat-map-cell" style="background-color: ${heatColor}; width: 100%;">
              &nbsp;
            </div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    // Obtener color para el mapa de calor (verde para bajo, naranja para alto)
    function getHeatMapColor(percentage) {
      if (percentage < 0.2) {
        // Muy buen valor - verde
        return 'rgba(40, 167, 69, 0.7)';
      } else if (percentage < 0.5) {
        // Valor medio-bajo - verde claro a amarillo
        return `rgba(${Math.round(40 + (percentage * 2 * 215))}, 167, 69, 0.7)`;
      } else if (percentage < 0.8) {
        // Valor medio-alto - amarillo a naranja
        return `rgba(${Math.round(215 + (percentage * 40))}, ${Math.round(167 - (percentage * 167))}, 0, 0.7)`;
      } else {
        // Valor alto - naranja a rojo
        return `rgba(253, ${Math.round(76 * (1 - percentage))}, 11, 0.7)`;
      }
    }
  </script>
</body>
</html>
