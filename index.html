<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Crédito Hipotecario Multibanco Agile Home</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Custom CSS -->
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --info-color: #17a2b8;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }
    
    .brand-title {
      color: var(--primary-color);
      font-weight: 700;
    }
    
    .subtitle {
      color: var(--secondary-color);
    }
    
    .section-title {
      color: var(--primary-color);
      font-weight: 500;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    
    .card-header {
      background-color: rgba(0, 123, 255, 0.1);
      font-weight: 500;
    }
    
    .form-control, .form-select {
      border-radius: 5px;
      border: 1px solid #ced4da;
      padding: 10px 15px;
    }
    
    .tooltip-icon {
      color: var(--info-color);
      cursor: pointer;
    }
    
    .error-message {
      color: var(--danger-color);
      font-size: 0.8rem;
    }
    
    .result-card {
      transition: all 0.3s ease;
    }
    
    .result-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .payment-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .highlight {
      font-size: 1.2rem;
      font-weight: 500;
      color: var(--primary-color);
    }
    
    .comparison-table th {
      width: 50%;
    }
    
    .amortization-table-container {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .amortization-table {
      font-size: 0.85rem;
    }
    
    .footer {
      background-color: #f1f1f1;
      padding: 30px 0;
      border-top: 1px solid #e1e1e1;
    }
    
    .btn-success {
      background-color: #25D366;
      border-color: #25D366;
      font-weight: 500;
    }
    
    .btn-success:hover {
      background-color: #1eb959;
      border-color: #1eb959;
    }
    
    @media (max-width: 768px) {
      .payment-value {
        font-size: 1.3rem;
      }
      
      .highlight {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="bg-white py-3 shadow-sm">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-12 text-center">
          <h1 class="brand-title mb-0">Simulador de Crédito Hipotecario Multibanco Agile Home</h1>
          <p class="subtitle mb-0">Compare opciones de préstamos hipotecarios en Colombia</p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="py-4">
    <div class="container">
      <!-- Introduction Card -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="section-title">¿Cómo funciona?</h5>
          <p>Este simulador le permite calcular y comparar cuotas mensuales de créditos hipotecarios ofrecidos por diferentes bancos en Colombia. Ingrese los datos solicitados para obtener una estimación de sus pagos mensuales.</p>
          <div class="row mt-3">
            <div class="col-md-4 text-center mb-3 mb-md-0">
              <i class="bi bi-house-door fs-1 text-primary"></i>
              <h6 class="mt-2">Ingrese el valor de la vivienda</h6>
            </div>
            <div class="col-md-4 text-center mb-3 mb-md-0">
              <i class="bi bi-calculator fs-1 text-primary"></i>
              <h6 class="mt-2">Defina la cuota inicial y el plazo</h6>
            </div>
            <div class="col-md-4 text-center">
              <i class="bi bi-bank fs-1 text-primary"></i>
              <h6 class="mt-2">Compare entre diferentes bancos</h6>
            </div>
          </div>
        </div>
      </div>

      <!-- Error Messages Container -->
      <div id="validationErrors" class="d-none mb-4"></div>

      <!-- Loan Calculator Form -->
      <div class="card mb-4">
        <div class="card-header">
          Información del Préstamo
        </div>
        <div class="card-body">
          <form id="mortgageForm">
            <div class="row">
              <!-- Property Value -->
              <div class="col-md-6 mb-3">
                <label for="propertyValue">Valor de la vivienda <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Ingrese el valor total de la propiedad que desea adquirir"></i></label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="text" class="form-control currency-input" id="propertyValue" placeholder="Ej. 200.000.000" required>
                </div>
              </div>

              <!-- Down Payment -->
              <div class="col-md-6 mb-3">
                <label for="downPayment">Cuota inicial <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Se recomienda una cuota inicial de al menos 20% del valor de la vivienda"></i></label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="text" class="form-control currency-input" id="downPayment" placeholder="Ej. 40.000.000" required>
                </div>
                <div class="d-flex justify-content-between">
                  <small class="text-muted">Equivale al <span id="downPaymentPercentage">0</span>% del valor</small>
                  <small id="downPaymentFeedback" class="error-message d-none"></small>
                </div>
              </div>

              <!-- Loan Amount Summary -->
              <div class="col-12 mb-3">
                <div class="alert alert-info">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>Monto a financiar:</strong>
                    </div>
                    <div>
                      <strong>$<span id="loanAmount">0</span></strong>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Loan Term -->
              <div class="col-md-6 mb-3">
                <label for="loanTerm">Plazo en años <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Período de tiempo para pagar el préstamo, entre 5 y 30 años"></i></label>
                <select class="form-select" id="loanTerm" required>
                  <option value="" selected disabled>Seleccione el plazo</option>
                  <option value="5">5 años</option>
                  <option value="10">10 años</option>
                  <option value="15">15 años</option>
                  <option value="20">20 años</option>
                  <option value="25">25 años</option>
                  <option value="30">30 años</option>
                </select>
                <small id="loanTermFeedback" class="error-message d-none"></small>
              </div>
            </div>

            <!-- Form Buttons -->
            <div class="d-flex justify-content-between mt-3">
              <button type="button" id="resetBtn" class="btn btn-outline-secondary">
                Reiniciar
              </button>
              <button type="button" id="calculateBtn" class="btn btn-primary">
                Calcular cuotas
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultsContainer" class="d-none">
        <h3 class="section-title mb-4">
          Resultados de la Simulación
        </h3>
        
        <!-- Results Content -->
        <div id="resultsContent"></div>
        
        <!-- WhatsApp Contact Button -->
        <div class="text-center my-4">
          <br>
          <a href="https://wa.me/message/PMWO6BQHZCRSD1" target="_blank" class="btn btn-success btn-lg">
            <i class="bi bi-whatsapp me-2"></i>Contactar asesor por WhatsApp
          </a>
          <p class="text-muted mt-2"><small>Un asesor de Agile Home te brindará información detallada sobre tu simulación</small></p>
        </div>
        
        <!-- Comparison Chart -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-bar-chart-fill me-2"></i>Comparativa de Cuotas Mensuales
          </div>
          <div class="card-body">
            <div style="max-height: 250px;">
              <canvas id="comparisonChart" class="d-none" height="200"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Interest Rate Heat Map -->
        <div class="card mt-4">
          <div class="card-header">
            <i class="bi bi-grid-3x3-gap me-2"></i>Mapa de Calor de Tasas de Interés
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">Este mapa de calor muestra visualmente qué bancos ofrecen las mejores tasas de interés. Los colores más verdes indican tasas más bajas, mientras que los colores más rojos indican tasas más altas.</p>
            <div id="heatMapContainer" class="d-none">
              <div class="table-responsive">
                <table id="interestRateHeatMap" class="table table-bordered">
                  <thead class="table-primary">
                    <tr>
                      <th>Banco</th>
                      <th>Tasa EA</th>
                      <th>Tasa MV</th>
                      <th>Comparativa Visual</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Se llenará dinámicamente con JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Disclaimer -->
        <div style="font-size: 0.9em; color: #555; margin-top: 20px;">
          <strong>Esta herramienta realiza estimaciones aproximadas en Pesos Colombianos (COP).</strong>
          <ul class="mb-0 mt-2">
            <li>Las tasas de interés y condiciones pueden variar según la política de cada entidad financiera.</li>
            <li>La cuota mensual no incluye seguros ni otros costos asociados.</li>
            <li>La tasa definitiva aplicará según las condiciones vigentes al momento del desembolso.</li>
            <li>Para conocer el detalle de cada banco, contacta a tu asesor de Agile Home.</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer mt-5">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <h5>Simulador de Crédito Hipotecario Multibanco Agile Home</h5>
          <div class="mb-0">
            <strong>Esta herramienta realiza estimaciones aproximadas en Pesos Colombianos (COP).</strong>
            <ul class="mb-0 mt-1">
              <li>Las tasas de interés y condiciones pueden variar según la política de cada entidad financiera.</li>
              <li>La cuota mensual no incluye seguros ni otros costos asociados.</li>
              <li>La tasa definitiva aplicará según las condiciones vigentes al momento del desembolso.</li>
              <li>Para conocer el detalle de cada banco, contacta a tu asesor de Agile Home.</li>
            </ul>
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <p class="mb-0">© 2025 Simulador Multibanco Agile Home</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- JavaScript Principal -->
  <script>
    // Datos de los bancos
    let banks = {};

    // Cargar datos de los bancos desde JSON
    async function loadBankData() {
      try {
        const response = await fetch('tasas_bancarias.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        banks = data.banks;
        
        // Mostrar fecha de última actualización si existe
        if (data.lastUpdated) {
          const lastUpdatedElement = document.createElement('div');
          lastUpdatedElement.className = 'text-muted small';
          lastUpdatedElement.innerHTML = `Tasas actualizadas: ${data.lastUpdated}`;
          document.querySelector('footer .container').appendChild(lastUpdatedElement);
        }
        
        console.log('Datos de bancos cargados correctamente:', banks);
      } catch (error) {
        console.error('Error al cargar los datos de los bancos:', error);
        // Datos de respaldo en caso de error
        banks = {
          "Banco de Occidente": {
            rate: 0.1290,
            rateDescription: "Desde",
            logoClass: "bi-bank"
          },
          "Banco Caja Social": {
            rate: 0.1310,
            rateDescription: "Tasa promedio",
            logoClass: "bi-house"
          },
          "Credifamilia": {
            rate: 0.1410,
            rateDescription: "Desde",
            logoClass: "bi-building"
          },
          "BBVA": {
            rate: 0.1265,
            rateDescription: "Tasa promedio",
            logoClass: "bi-bank2"
          },
          "Itaú": {
            rate: 0.1380,
            rateDescription: "Desde",
            logoClass: "bi-building-fill"
          },
          "Banco de Bogotá": {
            rate: 0.1275,
            rateDescription: "Desde",
            logoClass: "bi-bank"
          }
        };
      }
    }

    // Inicialización cuando el documento está listo
    document.addEventListener('DOMContentLoaded', async function() {
      // Cargar datos de los bancos
      await loadBankData();
      
      // Inicializar tooltips de Bootstrap
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Referencias a elementos del DOM
      const propertyValueInput = document.getElementById('propertyValue');
      const downPaymentInput = document.getElementById('downPayment');
      const loanAmountDisplay = document.getElementById('loanAmount');
      const downPaymentPercentageDisplay = document.getElementById('downPaymentPercentage');
      const calculateBtn = document.getElementById('calculateBtn');
      const resetBtn = document.getElementById('resetBtn');

      // Event listeners
      propertyValueInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      downPaymentInput.addEventListener('input', function() {
        formatInputCurrency(this);
        calculateLoanAmount();
      });

      calculateBtn.addEventListener('click', calculateMortgage);
      
      resetBtn.addEventListener('click', resetForm);
    });

    // Formatear número como moneda colombiana
    function formatCurrency(value) {
      const num = value.toString().replace(/\D/g, '');
      return new Intl.NumberFormat('es-CO', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(num);
    }

    // Formatear entrada de moneda mientras se escribe
    function formatInputCurrency(input) {
      const cursorPosition = input.selectionStart;
      const oldLength = input.value.length;
      const cleanValue = input.value.replace(/\D/g, '');
      
      if (cleanValue) {
        input.value = formatCurrency(cleanValue);
      } else {
        input.value = '';
      }
      
      // Ajustar posición del cursor
      const newLength = input.value.length;
      const newPosition = cursorPosition + (newLength - oldLength);
      input.setSelectionRange(newPosition, newPosition);
    }

    // Convertir string de moneda a número
    function parseCurrency(value) {
      return parseInt(value.toString().replace(/\D/g, '')) || 0;
    }

    // Calcular y mostrar monto del préstamo
    function calculateLoanAmount() {
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
      const downPayment = parseCurrency(document.getElementById('downPayment').value);
      
      // Calcular monto del préstamo
      let loanAmount = propertyValue - downPayment;
      if (loanAmount < 0) loanAmount = 0;
      
      // Actualizar pantalla
      const loanAmountDisplay = document.getElementById('loanAmount');
      loanAmountDisplay.textContent = formatCurrency(loanAmount);
      
      // Calcular porcentaje de cuota inicial
      const downPaymentPercentage = propertyValue > 0 ? (downPayment / propertyValue * 100).toFixed(1) : 0;
      document.getElementById('downPaymentPercentage').textContent = downPaymentPercentage;
      
      // Validar cuota inicial (debería ser al menos 20% en Colombia)
      const downPaymentFeedback = document.getElementById('downPaymentFeedback');
      if (propertyValue > 0 && downPaymentPercentage < 20) {
        downPaymentFeedback.textContent = 'Se recomienda un mínimo de 20% de cuota inicial';
        downPaymentFeedback.classList.remove('d-none');
      } else {
        downPaymentFeedback.classList.add('d-none');
      }
    }

    // Validar plazo del préstamo
    function validateLoanTerm() {
      const loanTerm = parseInt(document.getElementById('loanTerm').value);
      const loanTermFeedback = document.getElementById('loanTermFeedback');
      
      if (isNaN(loanTerm) || loanTerm < 5 || loanTerm > 30) {
        loanTermFeedback.textContent = 'El plazo debe estar entre 5 y 30 años';
        loanTermFeedback.classList.remove('d-none');
        return false;
      } else {
        loanTermFeedback.classList.add('d-none');
        return true;
      }
    }

    // Función principal de cálculo
    function calculateMortgage() {
      // Obtener valores de entrada
      const propertyValue = parseCurrency(document.getElementById('propertyValue').value);
      const downPayment = parseCurrency(document.getElementById('downPayment').value);
      const loanTerm = parseInt(document.getElementById('loanTerm').value);
      
      // Validar entradas
      const validationMessages = [];
      
      if (propertyValue <= 0) {
        validationMessages.push('El valor de la vivienda debe ser mayor a cero');
      }
      
      if (downPayment <= 0) {
        validationMessages.push('La cuota inicial debe ser mayor a cero');
      }
      
      if (downPayment >= propertyValue) {
        validationMessages.push('La cuota inicial no puede ser mayor o igual al valor de la vivienda');
      }
      
      if (isNaN(loanTerm) || loanTerm < 5 || loanTerm > 30) {
        validationMessages.push('El plazo debe estar entre 5 y 30 años');
      }
      
      // Mostrar errores de validación si los hay
      const errorContainer = document.getElementById('validationErrors');
      if (validationMessages.length > 0) {
        errorContainer.innerHTML = validationMessages.map(msg => `<div class="alert alert-danger">${msg}</div>`).join('');
        errorContainer.classList.remove('d-none');
        document.getElementById('resultsContainer').classList.add('d-none');
        return;
      }
      
      // Limpiar errores anteriores y continuar con el cálculo
      errorContainer.classList.add('d-none');
      
      // Mostrar estado de carga
      const calculateBtn = document.getElementById('calculateBtn');
      const originalBtnText = calculateBtn.innerHTML;
      calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Calculando...';
      calculateBtn.disabled = true;
      
      // Calcular monto del préstamo
      const loanAmount = propertyValue - downPayment;
      
      // Procesar cálculos bancarios con un ligero retraso para mostrar el estado de carga
      setTimeout(() => {
        // Calcular para cada banco
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsContent = document.getElementById('resultsContent');
        
        // Limpiar resultados anteriores
        resultsContent.innerHTML = '';
        
        // Ordenar bancos por pago mensual (menor primero)
        const bankResults = [];
        
        // Restricción especial: Si el plazo es mayor a 20 años y el valor del inmueble no supera $213.525.000
        // solo mostramos el Banco de Bogotá
        const mostrarSoloBogota = loanTerm > 20 && propertyValue <= 213525000;
        
        for (const bankName in banks) {
          // Si aplica la restricción especial y no es Banco de Bogotá, saltamos este banco
          if (mostrarSoloBogota && bankName !== "Banco de Bogotá") {
            continue;
          }
          
          const bank = banks[bankName];
          const yearlyRate = bank.rate;
          const monthlyRate = yearlyRate / 12;
          const paymentPeriods = loanTerm * 12;
          
          // Calcular pago mensual usando la fórmula: P = L[c(1+c)^n]/[(1+c)^n-1]
          // Donde P = pago mensual, L = monto del préstamo, c = tasa de interés mensual, n = número de pagos
          const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, paymentPeriods)) / (Math.pow(1 + monthlyRate, paymentPeriods) - 1);
          
          // Calcular interés total
          const totalPayment = monthlyPayment * paymentPeriods;
          const totalInterest = totalPayment - loanAmount;
          
          bankResults.push({
            bankName: bankName,
            logoClass: bank.logoClass,
            yearlyRate: yearlyRate,
            rateDescription: bank.rateDescription || "",
            monthlyPayment: monthlyPayment,
            totalPayment: totalPayment,
            totalInterest: totalInterest
          });
        }
        
        // Si no hay resultados (caso raro), mostramos un mensaje de advertencia
        if (bankResults.length === 0) {
          const errorContainer = document.getElementById('validationErrors');
          errorContainer.innerHTML = '<div class="alert alert-warning">No hay bancos disponibles para los criterios seleccionados. Por favor ajusta el plazo o valor del inmueble.</div>';
          errorContainer.classList.remove('d-none');
          document.getElementById('resultsContainer').classList.add('d-none');
          
          // Restaurar estado del botón
          calculateBtn.innerHTML = originalBtnText;
          calculateBtn.disabled = false;
          return;
        }
        
        // Ordenar por pago mensual
        bankResults.sort((a, b) => a.monthlyPayment - b.monthlyPayment);
        
        // Crear tarjetas de resultados
        bankResults.forEach((result, index) => {
          const isBestRate = index === 0 ? '<span class="badge bg-success ms-2">Mejor opción</span>' : '';
          
          const resultCard = document.createElement('div');
          resultCard.className = 'card result-card mb-3';
          resultCard.innerHTML = `
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-3 text-center text-md-start mb-3 mb-md-0">
                  <i class="bi ${result.logoClass} fs-1 text-primary"></i>
                  <h5 class="mb-0">${result.bankName}${isBestRate}</h5>
                </div>
                <div class="col-md-3 text-center mb-3 mb-md-0">
                  <div class="text-muted fs-6">Tasas</div>
                  <div class="highlight">${result.rateDescription ? result.rateDescription + ' ' : ''}${(result.yearlyRate * 100).toFixed(2)}% EA</div>
                  <div class="text-muted fs-6">${((Math.pow(1 + result.yearlyRate, 1/12) - 1) * 100).toFixed(2)}% MV</div>
                </div>
                <div class="col-md-3 text-center mb-3 mb-md-0">
                  <div class="text-muted fs-6">Cuota Mensual</div>
                  <div class="payment-value">$${formatCurrency(Math.round(result.monthlyPayment))}</div>
                </div>
                <div class="col-md-3 text-center mb-3 mb-md-0">
                  <button class="btn btn-sm btn-outline-primary view-details-btn" data-bank="${result.bankName}">Ver detalles</button>
                </div>
              </div>
              <div class="mt-3 bank-details d-none" id="details-${result.bankName.replace(/\s+/g, '-')}">
                <p><strong>Valor de la propiedad:</strong> $${formatCurrency(propertyValue)}</p>
                <p><strong>Monto del crédito:</strong> $${formatCurrency(loanAmount)}</p>
                <p><strong>Plazo:</strong> ${loanTerm} años</p>
                <p><strong>Tasa EA:</strong> ${result.rateDescription ? result.rateDescription + ' ' : ''}${(result.yearlyRate * 100).toFixed(2)}%</p>
                <p><strong>Tasa MV:</strong> ${((Math.pow(1 + result.yearlyRate, 1/12) - 1) * 100).toFixed(2)}%</p>
                
                <table class="table table-sm comparison-table mt-3">
                  <tr>
                    <th>Total a pagar:</th>
                    <td>$${formatCurrency(Math.round(result.totalPayment))}</td>
                  </tr>
                  <tr>
                    <th>Intereses totales:</th>
                    <td>$${formatCurrency(Math.round(result.totalInterest))}</td>
                  </tr>
                </table>
                
                <div class="amortization-section mt-4">
                  <h6 class="mb-3">Tabla de Amortización</h6>
                  <div id="amortization-${result.bankName.replace(/\s+/g, '-')}" class="amortization-table-container"></div>
                </div>
              </div>
            </div>
          `;
          
          resultsContent.appendChild(resultCard);
          
          // Generar tabla de amortización
          const detailsContainer = resultCard.querySelector(`#details-${result.bankName.replace(/\s+/g, '-')}`);
          const amortizationContainer = resultCard.querySelector(`#amortization-${result.bankName.replace(/\s+/g, '-')}`);
          generateAmortizationTable(result.bankName, result.yearlyRate, loanAmount, loanTerm, amortizationContainer);
          
          // Agregar event listener al botón "Ver detalles"
          const viewDetailsBtn = resultCard.querySelector('.view-details-btn');
          viewDetailsBtn.addEventListener('click', function() {
            const bankName = this.getAttribute('data-bank');
            const detailsElement = document.getElementById(`details-${bankName.replace(/\s+/g, '-')}`);
            
            if (detailsElement.classList.contains('d-none')) {
              // Cerrar cualquier detalle abierto primero
              document.querySelectorAll('.bank-details').forEach(el => {
                el.classList.add('d-none');
              });
              // Abrir este
              detailsElement.classList.remove('d-none');
              this.textContent = 'Ocultar detalles';
              
              // Establecer todos los otros botones de nuevo a "Ver detalles"
              document.querySelectorAll('.view-details-btn').forEach(btn => {
                if (btn !== this) {
                  btn.textContent = 'Ver detalles';
                }
              });
            } else {
              detailsElement.classList.add('d-none');
              this.textContent = 'Ver detalles';
            }
          });
        });
        
        // Mostrar contenedor de resultados
        resultsContainer.classList.remove('d-none');
        
        // Generar gráfico comparativo
        generateComparisonChart(bankResults);
        
        // Generar mapa de calor de tasas de interés
        generateInterestRateHeatMap(bankResults);
        
        // Restaurar estado del botón
        calculateBtn.innerHTML = originalBtnText;
        calculateBtn.disabled = false;
        
        // Desplazarse a los resultados
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
      }, 500);
    }

    // Generar tabla de amortización para un banco
    function generateAmortizationTable(bankName, yearlyRate, loanAmount, loanTerm, container) {
      const monthlyRate = yearlyRate / 12;
      const paymentPeriods = loanTerm * 12;
      
      // Calcular pago mensual
      const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, paymentPeriods)) / (Math.pow(1 + monthlyRate, paymentPeriods) - 1);
      
      // Crear tabla
      const table = document.createElement('table');
      table.className = 'table table-sm table-hover amortization-table';
      
      // Crear encabezado
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>Año</th>
          <th>Capital</th>
          <th>Intereses</th>
          <th>Saldo</th>
        </tr>
      `;
      table.appendChild(thead);
      
      // Crear cuerpo
      const tbody = document.createElement('tbody');
      
      // Generar filas para cada año del préstamo
      const yearlyRows = generateAmortizationRows(loanAmount, monthlyRate, monthlyPayment, paymentPeriods);
      
      yearlyRows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.year}</td>
          <td>$${formatCurrency(Math.round(row.principal))}</td>
          <td>$${formatCurrency(Math.round(row.interest))}</td>
          <td>$${formatCurrency(Math.round(row.balance))}</td>
        `;
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      container.appendChild(table);
    }

    // Generar datos de tabla de amortización
    function generateAmortizationRows(loanAmount, monthlyRate, monthlyPayment, periods) {
      const yearlyData = [];
      let remainingBalance = loanAmount;
      let yearlyPrincipal = 0;
      let yearlyInterest = 0;
      
      // Para cada período de pago (mes)
      for (let i = 1; i <= periods; i++) {
        // Calcular interés para este período
        const interestForPeriod = remainingBalance * monthlyRate;
        
        // Calcular capital para este período
        const principalForPeriod = monthlyPayment - interestForPeriod;
        
        // Actualizar yearlyPrincipal y yearlyInterest
        yearlyPrincipal += principalForPeriod;
        yearlyInterest += interestForPeriod;
        
        // Actualizar saldo restante
        remainingBalance -= principalForPeriod;
        
        // Si este es el último mes de un año (o el último pago), agregar a yearlyData
        if (i % 12 === 0 || i === periods) {
          yearlyData.push({
            year: Math.ceil(i / 12),
            principal: yearlyPrincipal,
            interest: yearlyInterest,
            balance: Math.max(0, remainingBalance)
          });
          
          // Reiniciar contadores anuales
          yearlyPrincipal = 0;
          yearlyInterest = 0;
        }
      }
      
      return yearlyData;
    }

    // Generar gráfico comparativo
    function generateComparisonChart(bankResults) {
      const chartContainer = document.getElementById('comparisonChart');
      chartContainer.classList.remove('d-none');
      
      // Destruir gráfico existente si existe
      if (window.comparisonChart) {
        window.comparisonChart.destroy();
      }
      
      const ctx = chartContainer.getContext('2d');
      
      // Preparar datos
      const labels = bankResults.map(result => result.bankName);
      const monthlyPayments = bankResults.map(result => Math.round(result.monthlyPayment));
      const totalInterests = bankResults.map(result => Math.round(result.totalInterest));
      
      // Crear gráfico
      window.comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Cuota Mensual',
              data: monthlyPayments,
              backgroundColor: 'rgba(75, 192, 192, 0.6)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Cuota Mensual: $${formatCurrency(context.raw)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return `$${formatCurrency(value)}`;
                }
              }
            }
          }
        }
      });
    }

    // Restablecer el formulario
    function resetForm() {
      document.getElementById('propertyValue').value = '';
      document.getElementById('downPayment').value = '';
      document.getElementById('loanTerm').value = '';
      document.getElementById('loanAmount').textContent = '0';
      document.getElementById('downPaymentPercentage').textContent = '0';
      document.getElementById('downPaymentFeedback').classList.add('d-none');
      document.getElementById('loanTermFeedback').classList.add('d-none');
      document.getElementById('validationErrors').classList.add('d-none');
      document.getElementById('resultsContainer').classList.add('d-none');
    }

    // Generar mapa de calor de tasas de interés
    function generateInterestRateHeatMap(bankResults) {
      const heatMapContainer = document.getElementById('heatMapContainer');
      const heatMapTable = document.getElementById('interestRateHeatMap').querySelector('tbody');
      
      // Limpiar contenido previo
      heatMapTable.innerHTML = '';
      
      // Si hay resultados de bancos, mostrar el contenedor
      if (bankResults.length > 0) {
        heatMapContainer.classList.remove('d-none');
        
        // Ordenar bancos por tasa anual (menor primero)
        const sortedResults = [...bankResults].sort((a, b) => a.yearlyRate - b.yearlyRate);
        
        // Obtener la tasa más baja como base para comparación
        const lowestRate = sortedResults[0].yearlyRate;
        
        // Generar filas para cada banco
        sortedResults.forEach(result => {
          const row = document.createElement('tr');
          
          // Calcular diferencia porcentual de la tasa más baja
          const percentageDiff = result.yearlyRate === lowestRate 
            ? 0 
            : ((result.yearlyRate - lowestRate) / lowestRate) * 100;
          
          // Generar color basado en la diferencia porcentual
          let bgColor;
          if (percentageDiff === 0) {
            bgColor = 'rgba(40, 167, 69, 0.8)'; // Mejor tasa (verde)
          } else if (percentageDiff <= 5) {
            bgColor = 'rgba(40, 167, 69, 0.5)'; // Hasta 5% más alta (verde claro)
          } else if (percentageDiff <= 10) {
            bgColor = 'rgba(255, 193, 7, 0.5)'; // 5-10% más alta (amarillo)
          } else if (percentageDiff <= 15) {
            bgColor = 'rgba(255, 145, 0, 0.5)'; // 10-15% más alta (naranja)
          } else {
            bgColor = 'rgba(220, 53, 69, 0.5)'; // >15% más alta (rojo)
          }
          
          // Generar texto para celda de comparación
          let comparisonText = '';
          if (percentageDiff === 0) {
            comparisonText = 'Mejor tasa de interés';
          } else {
            comparisonText = `+${percentageDiff.toFixed(1)}% respecto a la mejor tasa`;
          }
          
          // Generar HTML de la fila
          row.innerHTML = `
            <td>${result.bankName}</td>
            <td>${result.rateDescription ? result.rateDescription + ' ' : ''}${(result.yearlyRate * 100).toFixed(2)}%</td>
            <td>${((Math.pow(1 + result.yearlyRate, 1/12) - 1) * 100).toFixed(2)}%</td>
            <td class="text-center">
              <div class="heat-map-cell" style="background-color: ${bgColor}; padding: 8px; border-radius: 4px; color: #333;">
                ${comparisonText}
              </div>
            </td>
          `;
          
          heatMapTable.appendChild(row);
        });
      } else {
        heatMapContainer.classList.add('d-none');
      }
    }

    // Agregar delegación de eventos para los botones de detalles
    document.addEventListener('click', function(e) {
      if (e.target && e.target.closest('.view-details-btn')) {
        const btn = e.target.closest('.view-details-btn');
        const bankName = btn.getAttribute('data-bank');
        const detailsElement = document.getElementById(`details-${bankName.replace(/\s+/g, '-')}`);
        
        if (detailsElement) {
          if (detailsElement.classList.contains('d-none')) {
            // Cerrar cualquier detalle abierto primero
            document.querySelectorAll('.bank-details').forEach(el => {
              el.classList.add('d-none');
            });
            // Abrir este
            detailsElement.classList.remove('d-none');
            btn.textContent = 'Ocultar detalles';
            
            // Establecer todos los otros botones de nuevo a "Ver detalles"
            document.querySelectorAll('.view-details-btn').forEach(otherBtn => {
              if (otherBtn !== btn) {
                otherBtn.textContent = 'Ver detalles';
              }
            });
          } else {
            detailsElement.classList.add('d-none');
            btn.textContent = 'Ver detalles';
          }
        }
      }
    });
  </script>
</body>
</html>
